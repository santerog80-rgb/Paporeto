<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <script src="config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PapoReto ‚Äî Perfil & Configura√ß√µes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--green:#00C16A;--green-dark:#009E56;--green-glow:rgba(0,193,106,.2);--bg:#0A0F14;--surface:#111820;--surface2:#19232F;--border:#1E2A38;--text:#E8F0F8;--muted:#6B7F94;--subtle:#2E3D50;--red:#FF4757;--orange:#FF8C42;--purple:#BC8CFF;--blue:#58A6FF}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

    .topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:58px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:20}
    .back-btn{padding:8px 14px;border-radius:9px;border:none;background:transparent;color:var(--muted);font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;transition:all .2s}
    .back-btn:hover{color:var(--text);background:var(--surface2)}
    .page-title{font-size:17px;font-weight:700}

    .page-body{max-width:820px;margin:0 auto;padding:30px 24px;display:grid;grid-template-columns:280px 1fr;gap:22px;align-items:start}
    @media(max-width:760px){.page-body{grid-template-columns:1fr;padding:16px}}

    /* CARD */
    .card{background:var(--surface);border:1px solid var(--border);border-radius:20px;overflow:hidden;animation:fadeUp .4s ease}
    @keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

    /* PROFILE LEFT */
    .profile-banner{height:110px;background:linear-gradient(135deg,#0D2B1A,#091C10);position:relative}
    .profile-banner::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(0,193,106,.12) 0%,transparent 70%)}
    .avatar-section{padding:0 20px}
    .avatar-wrap{display:flex;align-items:flex-end;justify-content:space-between;margin-top:-44px;margin-bottom:16px}
    .profile-big-av{width:88px;height:88px;border-radius:50%;background:linear-gradient(135deg,var(--green),var(--green-dark));border:4px solid var(--surface);display:flex;align-items:center;justify-content:center;font-size:34px;font-weight:700;color:#000;overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;transition:all .2s}
    .profile-big-av:hover .av-overlay{opacity:1}
    .av-overlay{position:absolute;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;font-size:20px;opacity:0;transition:opacity .2s;border-radius:50%}
    .profile-big-av img{width:100%;height:100%;object-fit:cover}
    .edit-av-btn{padding:8px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;font-size:12px;font-weight:600;color:var(--text);cursor:pointer;font-family:'Sora',sans-serif;transition:all .2s}
    .edit-av-btn:hover{border-color:var(--green)}

    .profile-name{font-size:20px;font-weight:800;letter-spacing:-.4px}
    .profile-phone{font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;margin-top:4px}
    .profile-uid{font-size:11px;color:var(--subtle);font-family:'Space Mono',monospace;margin-top:4px;word-break:break-all}
    .online-status{display:inline-flex;align-items:center;gap:6px;margin-top:8px;font-size:12px;color:var(--green);font-weight:600;background:rgba(0,193,106,.08);border:1px solid rgba(0,193,106,.15);padding:4px 10px;border-radius:20px}
    .online-dot{width:7px;height:7px;background:var(--green);border-radius:50%;animation:blink 1.5s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

    .profile-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);margin-top:16px;border-top:1px solid var(--border)}
    .stat{background:var(--surface);padding:14px 0;text-align:center}
    .stat-val{font-size:20px;font-weight:800}
    .stat-label{font-size:11px;color:var(--muted);margin-top:3px}

    /* RIGHT SETTINGS */
    .settings-stack{display:flex;flex-direction:column;gap:16px}
    .settings-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;animation:fadeUp .4s ease}

    .sc-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .sc-icon{font-size:18px}
    .sc-title{font-size:14px;font-weight:700}
    .sc-sub{font-size:12px;color:var(--muted);margin-top:2px}

    /* Form */
    .sc-body{padding:20px}
    .fg{margin-bottom:16px}
    .fg label{display:block;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px}
    .input-wrap{position:relative}
    .input-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:15px;color:var(--muted);pointer-events:none}
    .fg input,.fg select,.fg textarea{width:100%;padding:11px 14px 11px 40px;background:var(--surface2);border:1.5px solid var(--border);border-radius:11px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;outline:none;transition:all .2s;-webkit-appearance:none}
    .fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(0,193,106,.1)}
    .fg input::placeholder,.fg textarea::placeholder{color:var(--subtle)}
    .fg textarea{padding-left:14px;min-height:80px;resize:vertical;line-height:1.6}
    .fg .no-icon{padding-left:14px}

    /* Toggle */
    .toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
    .toggle-row:last-child{border:none;padding-bottom:0}
    .toggle-info p:first-child{font-size:13px;font-weight:600}
    .toggle-info p:last-child{font-size:11px;color:var(--muted);margin-top:3px}
    .toggle-switch{position:relative;width:44px;height:24px;flex-shrink:0;cursor:pointer}
    .toggle-switch input{opacity:0;width:0;height:0;position:absolute}
    .toggle-track{position:absolute;inset:0;background:var(--border);border-radius:24px;transition:background .2s}
    .toggle-thumb{position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 4px rgba(0,0,0,.4)}
    .toggle-switch input:checked+.toggle-track{background:var(--green)}
    .toggle-switch input:checked~.toggle-thumb{transform:translateX(20px)}

    /* Supabase section */
    .sb-config{background:rgba(255,140,66,.05);border:1px solid rgba(255,140,66,.2);border-radius:12px;padding:16px;margin-bottom:16px}
    .sb-config-title{font-size:13px;font-weight:700;color:var(--orange);display:flex;align-items:center;gap:6px;margin-bottom:10px}
    .sb-config p{font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:12px}

    /* Action buttons */
    .action-list{padding:0 20px 20px}
    .action-item{display:flex;align-items:center;justify-content:space-between;padding:13px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all .15s}
    .action-item:last-child{border:none}
    .action-item:hover .action-label{color:var(--green)}
    .action-item.danger:hover .action-label{color:var(--red)}
    .action-left{display:flex;align-items:center;gap:12px}
    .action-icon{font-size:18px;width:24px;text-align:center}
    .action-label{font-size:14px;font-weight:500;transition:color .15s}
    .action-sub{font-size:11px;color:var(--muted);margin-top:2px}

    /* Blocked list */
    .blocked-list{padding:12px 20px 20px}
    .blocked-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
    .blocked-item:last-child{border:none}
    .bl-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0;background:var(--red)20;color:var(--red)}
    .bl-info{flex:1}
    .bl-name{font-size:13px;font-weight:600}
    .bl-btn{padding:6px 12px;background:transparent;border:1.5px solid var(--border);border-radius:8px;color:var(--muted);font-family:'Sora',sans-serif;font-size:12px;cursor:pointer;transition:all .2s}
    .bl-btn:hover{border-color:var(--green);color:var(--green)}

    /* Save btn */
    .btn-save{width:100%;padding:13px;background:var(--green);color:#000;font-weight:700;font-family:'Sora',sans-serif;font-size:14px;border:none;border-radius:11px;cursor:pointer;transition:all .2s;margin-top:4px}
    .btn-save:hover{background:var(--green-dark);transform:translateY(-1px)}
    .btn-logout{width:100%;padding:13px;background:rgba(255,71,87,.1);color:var(--red);font-weight:700;font-family:'Sora',sans-serif;font-size:14px;border:1.5px solid rgba(255,71,87,.2);border-radius:11px;cursor:pointer;transition:all .2s}
    .btn-logout:hover{background:rgba(255,71,87,.2);border-color:var(--red)}

    .toast-wrap{position:fixed;top:16px;right:16px;z-index:200;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--green);border-radius:12px;padding:12px 14px;min-width:260px;display:flex;align-items:flex-start;gap:10px;box-shadow:0 8px 30px rgba(0,0,0,.5);pointer-events:all;cursor:pointer;animation:toastIn .3s ease}
    @keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
    .toast-icon{font-size:20px;flex-shrink:0}
    .toast-title{font-size:13px;font-weight:600}
    .toast-body{font-size:12px;color:var(--muted);margin-top:2px}
  </style>
</head>
<body>

<div class="topbar">
  <button class="back-btn" onclick="history.back()">‚Üê Voltar</button>
  <div class="page-title">üë§ Perfil & Configura√ß√µes</div>
</div>

<div class="page-body">

  <!-- LEFT: PROFILE CARD -->
  <div class="card">
    <div class="profile-banner"></div>
    <div class="avatar-section">
      <div class="avatar-wrap">
        <div class="profile-big-av" id="big-avatar" onclick="document.getElementById('av-input').click()">
          <div class="av-overlay">üì∑</div>
          <span id="av-initials">?</span>
        </div>
        <button class="edit-av-btn" onclick="document.getElementById('av-input').click()">‚úèÔ∏è Editar foto</button>
        <input type="file" id="av-input" accept="image/*" style="display:none" onchange="handleAvatarChange(event)">
      </div>
      <div class="profile-name" id="profile-name">‚Äî</div>
      <div class="profile-phone" id="profile-phone">‚Äî</div>
      <div class="profile-uid" id="profile-uid">ID: ‚Äî</div>
      <div class="online-status"><span class="online-dot"></span> Online agora</div>
    </div>

    <div class="profile-stats">
      <div class="stat">
        <div class="stat-val" id="stat-msgs">0</div>
        <div class="stat-label">Mensagens</div>
      </div>
      <div class="stat">
        <div class="stat-val" id="stat-groups">0</div>
        <div class="stat-label">Grupos</div>
      </div>
      <div class="stat">
        <div class="stat-val" id="stat-contacts">0</div>
        <div class="stat-label">Contatos</div>
      </div>
    </div>
  </div>

  <!-- RIGHT: SETTINGS -->
  <div class="settings-stack">

    <!-- EDIT PROFILE -->
    <div class="settings-card">
      <div class="sc-header">
        <span class="sc-icon">‚úèÔ∏è</span>
        <div>
          <div class="sc-title">Editar Perfil</div>
          <div class="sc-sub">Atualize suas informa√ß√µes pessoais</div>
        </div>
      </div>
      <div class="sc-body">
        <div class="fg">
          <label>Nome Completo</label>
          <div class="input-wrap">
            <span class="input-icon">üë§</span>
            <input type="text" id="edit-name" placeholder="Seu nome">
          </div>
        </div>
        <div class="fg">
          <label>E-mail</label>
          <div class="input-wrap">
            <span class="input-icon">‚úâ</span>
            <input type="email" id="edit-email" placeholder="seu@email.com" readonly style="opacity:.6;cursor:not-allowed">
          </div>
        </div>
        <div class="fg">
          <label>Bio / Recado</label>
          <textarea id="edit-bio" placeholder="Ol√°! Estou usando o PapoReto üéâ" class="no-icon"></textarea>
        </div>
        <div class="fg">
          <label>Telefone</label>
          <div class="input-wrap">
            <span class="input-icon">üì±</span>
            <input type="tel" id="edit-phone" placeholder="+258 84 123 4567" readonly style="opacity:.6;cursor:not-allowed">
          </div>
        </div>
        <button class="btn-save" onclick="saveProfile()">üíæ Salvar Altera√ß√µes</button>
      </div>
    </div>

    <!-- NOTIFICATIONS -->
    <div class="settings-card">
      <div class="sc-header">
        <span class="sc-icon">üîî</span>
        <div>
          <div class="sc-title">Notifica√ß√µes</div>
          <div class="sc-sub">Controle como recebe alertas</div>
        </div>
      </div>
      <div class="sc-body">
        <div class="toggle-row">
          <div class="toggle-info">
            <p>Mensagens</p>
            <p>Notificar em novas mensagens</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="notif-msgs" checked>
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info">
            <p>Grupos</p>
            <p>Alertas em mensagens de grupo</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="notif-groups" checked>
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info">
            <p>Status</p>
            <p>Notificar novos status de contatos</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="notif-status">
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info">
            <p>Sons</p>
            <p>Toques de notifica√ß√£o</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="notif-sound" checked>
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </label>
        </div>
      </div>
    </div>

    <!-- PRIVACY -->
    <div class="settings-card">
      <div class="sc-header">
        <span class="sc-icon">üîí</span>
        <div>
          <div class="sc-title">Privacidade</div>
          <div class="sc-sub">Controle quem pode ver o qu√™</div>
        </div>
      </div>
      <div class="sc-body">
        <div class="fg">
          <label>Quem v√™ minha foto</label>
          <select class="no-icon" style="padding:11px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:11px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;outline:none;width:100%">
            <option>Todos</option>
            <option>Apenas contatos</option>
            <option>Ningu√©m</option>
          </select>
        </div>
        <div class="toggle-row">
          <div class="toggle-info">
            <p>√öltima visualiza√ß√£o</p>
            <p>Mostrar quando esteve online</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="priv-lastseen" checked>
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </label>
        </div>
        <div class="toggle-row">
          <div class="toggle-info">
            <p>Confirma√ß√£o de leitura</p>
            <p>Mostrar ‚úì‚úì azul quando ler</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="priv-readreceipt" checked>
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </label>
        </div>
      </div>
    </div>

    <!-- SUPABASE CONFIG -->
    <div class="settings-card">
      <div class="sc-header">
        <span class="sc-icon">‚öôÔ∏è</span>
        <div>
          <div class="sc-title">Conex√£o Supabase</div>
          <div class="sc-sub">Configure o backend da aplica√ß√£o</div>
        </div>
      </div>
      <div class="sc-body">
        <div class="sb-config">
          <div class="sb-config-title">‚öôÔ∏è Configura√ß√£o necess√°ria</div>
          <p>Para funcionar com dados reais, conecte ao seu projeto Supabase. Crie uma conta gr√°tis em <strong>supabase.com</strong> e crie as tabelas necess√°rias.</p>
        </div>
        <div class="fg">
          <label>URL do Projeto</label>
          <div class="input-wrap">
            <span class="input-icon">üåê</span>
            <input type="text" id="sb-url" placeholder="https://xxx.supabase.co">
          </div>
        </div>
        <div class="fg">
          <label>Anon Key (chave p√∫blica)</label>
          <div class="input-wrap">
            <span class="input-icon">üîë</span>
            <input type="text" id="sb-key" placeholder="eyJhbGci...">
          </div>
        </div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:16px;font-size:12px;color:var(--muted);line-height:1.7">
          <strong style="color:var(--text);display:block;margin-bottom:8px">üìã Tabelas necess√°rias:</strong>
          <code style="font-family:'Space Mono',monospace;font-size:11px;color:var(--green)">users, messages, groups, group_members, statuses, message_reactions, typing_status, blocked_users, archived_chats</code>
        </div>
        <button class="btn-save" onclick="saveSupabaseConfig()">üîå Salvar e Reconectar</button>
      </div>
    </div>

    <!-- BLOCKED -->
    <div class="settings-card">
      <div class="sc-header">
        <span class="sc-icon">üö´</span>
        <div>
          <div class="sc-title">Contatos Bloqueados</div>
          <div class="sc-sub" id="blocked-count">0 bloqueados</div>
        </div>
      </div>
      <div class="blocked-list" id="blocked-list">
        <div style="text-align:center;padding:20px;color:var(--muted);font-size:13px">Nenhum contacto bloqueado</div>
      </div>
    </div>

    <!-- ACCOUNT ACTIONS -->
    <div class="settings-card">
      <div class="sc-header">
        <span class="sc-icon">üë§</span>
        <div>
          <div class="sc-title">Conta</div>
        </div>
      </div>
      <div class="action-list">
        <div class="action-item" onclick="exportData()">
          <div class="action-left">
            <span class="action-icon">üì§</span>
            <div>
              <div class="action-label">Exportar dados</div>
              <div class="action-sub">Baixar seu hist√≥rico de conversas</div>
            </div>
          </div>
          <span style="color:var(--muted)">‚Ä∫</span>
        </div>
        <div class="action-item" onclick="clearAllData()">
          <div class="action-left">
            <span class="action-icon">üóëÔ∏è</span>
            <div>
              <div class="action-label">Limpar dados locais</div>
              <div class="action-sub">Remove mensagens armazenadas localmente</div>
            </div>
          </div>
          <span style="color:var(--muted)">‚Ä∫</span>
        </div>
        <div class="action-item danger" onclick="deleteAccount()">
          <div class="action-left">
            <span class="action-icon">‚ö†Ô∏è</span>
            <div>
              <div class="action-label" style="color:var(--red)">Eliminar conta</div>
              <div class="action-sub">Esta a√ß√£o √© permanente e irrevers√≠vel</div>
            </div>
          </div>
          <span style="color:var(--muted)">‚Ä∫</span>
        </div>
      </div>
      <div style="padding:0 20px 20px">
        <button class="btn-logout" onclick="logout()">üö™ Sair da conta</button>
      </div>
    </div>

    <div style="text-align:center;color:var(--subtle);font-size:12px;padding:8px 0;font-family:'Space Mono',monospace">
      PapoReto v{PR.APP.version} ‚Ä¢ <a href='configuracoes.html' style='color:var(--green)'>Configura√ß√µes Avan√ßadas</a>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toast-wrap"></div>

<script>
  let session = null;

  window.addEventListener('load', () => {
    session = PR.Session.require('login.html'); if (!session) return;
    loadProfile();
    loadStats();
    loadBlocked();
    loadSbConfig();
  });

  function loadProfile() {
    // Avatar
    const av = document.getElementById('big-avatar');
    const initials = session.initials || getInitials(session.name);
    document.getElementById('av-initials').textContent = initials;
    av.style.background = `linear-gradient(135deg, var(--green), var(--green-dark))`;

    if (session.profile_url) {
      av.innerHTML = `<img src="${session.profile_url}" alt=""><div class="av-overlay">üì∑</div>`;
    }

    document.getElementById('profile-name').textContent = session.name || '‚Äî';
    document.getElementById('profile-phone').textContent = session.phone || '‚Äî';
    document.getElementById('profile-uid').textContent = `ID: ${session.id}`;

    document.getElementById('edit-name').value = session.name || '';
    document.getElementById('edit-email').value = session.email || '';
    document.getElementById('edit-phone').value = session.phone || '';
    document.getElementById('edit-bio').value = session.bio || '';

    // Load saved prefs
    const prefs = PR.Prefs.get();
    document.getElementById('notif-msgs').checked = prefs.notif_msgs!==false;
    document.getElementById('notif-groups').checked = prefs.notif_groups!==false;
    document.getElementById('notif-status').checked = prefs.notif_status||false;
    document.getElementById('notif-sound').checked = prefs.notif_sound!==false;
    document.getElementById('priv-lastseen').checked = prefs.priv_lastseen!==false;
    document.getElementById('priv-readreceipt').checked = prefs.priv_readreceipt!==false;
  }

  function loadStats() {
    const users = JSON.parse(localStorage.getItem('pr_users')||'[]');
    const groups = JSON.parse(localStorage.getItem('pr_groups')||'[]');
    const msgs = JSON.parse(localStorage.getItem('pr_demo_msgs')||'[]');
    document.getElementById('stat-msgs').textContent = msgs.length || Math.floor(Math.random()*120)+20;
    document.getElementById('stat-groups').textContent = groups.length || 2;
    document.getElementById('stat-contacts').textContent = users.length || 5;
  }

  function loadBlocked() {
    const blocked = JSON.parse(localStorage.getItem('pr_blocked')||'[]');
    const list = document.getElementById('blocked-list');
    document.getElementById('blocked-count').textContent = `${blocked.length} bloqueados`;

    if (!blocked.length) {
      list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:13px">Nenhum contato bloqueado</div>';
      return;
    }

    list.innerHTML = blocked.map(b => `
      <div class="blocked-item">
        <div class="bl-avatar">${getInitials(b.name)}</div>
        <div class="bl-info">
          <div class="bl-name">${esc(b.name)}</div>
        </div>
        <button class="bl-btn" onclick="unblock('${b.id}')">Desbloquear</button>
      </div>`).join('');
  }

  function unblock(id) {
    let blocked = JSON.parse(localStorage.getItem('pr_blocked')||'[]');
    blocked = blocked.filter(b=>b.id!==id);
    localStorage.setItem('pr_blocked',JSON.stringify(blocked));
    loadBlocked();
    toast('‚úÖ','Desbloqueado','Contato foi desbloqueado com sucesso.');
  }

  function loadSbConfig() {
    document.getElementById('sb-url').value = localStorage.getItem('pr_url')||'';
    document.getElementById('sb-key').value = localStorage.getItem('pr_key')||'';
  }

  function handleAvatarChange(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const av = document.getElementById('big-avatar');
      av.innerHTML = `<img src="${ev.target.result}" alt=""><div class="av-overlay">üì∑</div>`;
      session.profile_url = ev.target.result;
      localStorage.setItem('pr_session', JSON.stringify(session));
      toast('‚úÖ','Foto atualizada!','');
    };
    reader.readAsDataURL(file);
  }

  function saveProfile() {
    const name = document.getElementById('edit-name').value.trim();
    const bio = document.getElementById('edit-bio').value.trim();

    if (!name) { toast('‚ö†Ô∏è','Erro','O nome n√£o pode estar vazio.'); return; }

    session.name = name;
    session.bio = bio;
    session.initials = getInitials(name);
    localStorage.setItem('pr_session', JSON.stringify(session));

    document.getElementById('profile-name').textContent = name;
    document.getElementById('av-initials').textContent = getInitials(name);

    // Save preferences
    const prefs = {
      notif_msgs: document.getElementById('notif-msgs').checked,
      notif_groups: document.getElementById('notif-groups').checked,
      notif_status: document.getElementById('notif-status').checked,
      notif_sound: document.getElementById('notif-sound').checked,
      priv_lastseen: document.getElementById('priv-lastseen').checked,
      priv_readreceipt: document.getElementById('priv-readreceipt').checked,
    };
    PR.Prefs.set(prefs);

    toast('‚úÖ','Perfil guardado!','Suas altera√ß√µes foram salvas.');
  }

  function saveSupabaseConfig() {
    const url = document.getElementById('sb-url').value.trim();
    const key = document.getElementById('sb-key').value.trim();
    if (!url || !key) { toast('‚ö†Ô∏è','Erro','Preencha a URL e a chave do Supabase.'); return; }
    localStorage.setItem('pr_url', url);
    localStorage.setItem('pr_key', key);
    toast('‚úÖ','Config salva!','Recarregue o app para reconectar ao Supabase.');
  }

  function exportData() {
    const data = {
      session,
      messages: JSON.parse(localStorage.getItem('pr_demo_msgs')||'[]'),
      groups: JSON.parse(localStorage.getItem('pr_groups')||'[]'),
      exported_at: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `paporeto_export_${Date.now()}.json`;
    a.click();
    toast('üì§','Dados exportados!','Ficheiro JSON baixado.');
  }

  function clearAllData() {
    if (!confirm('Limpar todos os dados locais? (mensagens, grupos, status)')) return;
    ['pr_demo_msgs','pr_groups','pr_statuses','pr_blocked'].forEach(k=>localStorage.removeItem(k));
    toast('üóëÔ∏è','Dados limpos','Todos os dados locais foram removidos.');
  }

  function deleteAccount() {
    if (!confirm('Tem CERTEZA que quer eliminar sua conta? Esta a√ß√£o √© permanente!')) return;
    if (!confirm('√öltima confirma√ß√£o: eliminar conta permanentemente?')) return;
    ['pr_session','pr_users','pr_demo_msgs','pr_groups','pr_statuses','pr_blocked','pr_prefs'].forEach(k=>localStorage.removeItem(k));
    window.location.href='index.html';
  }

  function logout() {
    if (!confirm('Sair da sua conta?')) return;
    PR.Auth.signOut();
  }

  function getInitials(n){return PR_UTILS.getInitials(n)}
  function esc(s){return PR_UTILS.esc(s)}

  function toast(icon,title,body){
    const wrap=document.getElementById('toast-wrap');
    const t=document.createElement('div');
    t.className='toast';
    t.innerHTML=`<div class="toast-icon">${icon}</div><div><div class="toast-title">${title}</div>${body?`<div class="toast-body">${body}</div>`:''}</div>`;
    t.onclick=()=>t.remove();
    wrap.appendChild(t);
    setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(30px)';t.style.transition='all .3s';setTimeout(()=>t.remove(),300);},4500);
  }
</script>
</body>
</html>
