<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <script src="config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PapoReto ‚Äî Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green:#00C16A; --green-dark:#009E56; --green-glow:rgba(0,193,106,0.2);
      --bg:#0A0F14; --surface:#111820; --surface2:#19232F; --surface3:#1F2D3E;
      --border:#1E2A38; --text:#E8F0F8; --muted:#6B7F94; --subtle:#2E3D50;
      --red:#FF4757; --blue:#58A6FF; --orange:#FF8C42; --purple:#BC8CFF;
      --sent-bg:#0D2B1A; --sent-border:rgba(0,193,106,0.2);
      --recv-bg:#19232F; --recv-border:#1E2A38;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow:hidden}
    body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}

    /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
    .topbar{
      height:58px;background:var(--surface);border-bottom:1px solid var(--border);
      display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0;z-index:20
    }
    .topbar-logo{display:flex;align-items:center;gap:8px;text-decoration:none;margin-right:8px}
    .tl-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--green),var(--green-dark));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px}
    .tl-name{font-size:17px;font-weight:800;letter-spacing:-0.4px;color:var(--text)}
    .tl-name span{color:var(--green)}

    .nav-pill-wrap{display:flex;background:var(--bg);border-radius:10px;padding:3px;gap:2px}
    .nav-pill{padding:7px 14px;border:none;border-radius:8px;background:transparent;color:var(--muted);font-family:'Sora',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
    .nav-pill.active{background:var(--surface2);color:var(--green);font-weight:600}
    .nav-pill:hover:not(.active){color:var(--text)}
    .pill-badge{background:var(--red);color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:8px;min-width:18px;text-align:center}

    .topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}
    .topbar-search{display:flex;align-items:center;gap:8px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:7px 12px;transition:border-color .2s}
    .topbar-search:focus-within{border-color:var(--green)}
    .topbar-search input{background:transparent;border:none;outline:none;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;width:180px}
    .topbar-search input::placeholder{color:var(--subtle)}

    .icon-btn{width:36px;height:36px;border:none;border-radius:9px;background:transparent;color:var(--muted);font-size:17px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center}
    .icon-btn:hover{background:var(--surface2);color:var(--text)}

    .my-avatar-btn{width:36px;height:36px;border-radius:50%;background:var(--green);border:2px solid var(--border);cursor:pointer;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#000;transition:all .2s}
    .my-avatar-btn:hover{border-color:var(--green);transform:scale(1.05)}

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .app-body{display:flex;flex:1;overflow:hidden}

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar{width:300px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;transition:width .3s}
    .sb-header{padding:14px;border-bottom:1px solid var(--border)}
    .sb-search{position:relative}
    .sb-search input{width:100%;padding:9px 14px 9px 38px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;outline:none;transition:border-color .2s}
    .sb-search input:focus{border-color:var(--green)}
    .sb-search::before{content:'üîç';position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:13px;pointer-events:none}

    .panel{flex:1;overflow-y:auto;display:none}
    .panel.active{display:flex;flex-direction:column}
    .panel::-webkit-scrollbar{width:3px}
    .panel::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

    /* ‚îÄ‚îÄ CONTACT ITEM ‚îÄ‚îÄ */
    .contact-item{display:flex;align-items:center;gap:10px;padding:12px 14px;cursor:pointer;transition:all .15s;border-left:3px solid transparent;position:relative}
    .contact-item:hover{background:var(--surface2)}
    .contact-item.active{background:var(--surface3);border-left-color:var(--green)}
    .ci-avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;flex-shrink:0;overflow:hidden;position:relative}
    .ci-avatar img{width:100%;height:100%;object-fit:cover}
    .online-dot{position:absolute;bottom:1px;right:1px;width:11px;height:11px;background:var(--green);border-radius:50%;border:2px solid var(--surface)}
    .ci-info{flex:1;overflow:hidden;min-width:0}
    .ci-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ci-preview{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
    .ci-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
    .ci-time{font-size:11px;color:var(--subtle);font-family:'Space Mono',monospace}
    .unread{background:var(--green);color:#000;font-size:10px;font-weight:700;padding:2px 6px;border-radius:8px;min-width:18px;text-align:center}
    .group-tag{font-size:9px;font-weight:700;padding:2px 6px;background:rgba(188,140,255,0.15);color:var(--purple);border-radius:6px;border:1px solid rgba(188,140,255,0.2)}
    .archived-tag{font-size:9px;padding:2px 6px;background:var(--surface3);color:var(--muted);border-radius:6px}

    /* ‚îÄ‚îÄ NEW CHAT FAB ‚îÄ‚îÄ */
    .sb-fab{position:relative;padding:12px 14px;border-top:1px solid var(--border);flex-shrink:0}
    .sb-fab button{width:100%;padding:11px;background:var(--green);color:#000;font-weight:700;font-family:'Sora',sans-serif;font-size:13px;border:none;border-radius:10px;cursor:pointer;transition:all .2s}
    .sb-fab button:hover{background:var(--green-dark)}

    /* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
    .chat-area{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative}
    .chat-empty{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;color:var(--muted)}
    .empty-icon-wrap{width:100px;height:100px;background:var(--surface2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:44px;opacity:.4}

    /* ‚îÄ‚îÄ CHAT HEADER ‚îÄ‚îÄ */
    .chat-header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 18px;display:flex;align-items:center;gap:12px;flex-shrink:0;display:none}
    .ch-avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;flex-shrink:0;overflow:hidden}
    .ch-info{flex:1}
    .ch-name{font-size:15px;font-weight:700}
    .ch-status{font-size:12px;color:var(--muted);margin-top:2px}
    .ch-status.online{color:var(--green)}
    .ch-status.typing{color:var(--green);font-style:italic}
    .ch-actions{display:flex;gap:2px}
    .call-btn{color:var(--green)!important}

    /* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
    .messages-wrap{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:3px;background:var(--bg);display:none;
      background-image:radial-gradient(ellipse at 5% 5%,rgba(0,193,106,0.03) 0%,transparent 50%)}
    .messages-wrap::-webkit-scrollbar{width:4px}
    .messages-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

    .date-div{text-align:center;margin:10px 0;display:flex;align-items:center;gap:10px}
    .date-div::before,.date-div::after{content:'';flex:1;height:1px;background:var(--border)}
    .date-div span{font-size:11px;color:var(--subtle);font-family:'Space Mono',monospace;padding:3px 12px;background:var(--surface2);border-radius:8px}

    .msg-wrap{display:flex;align-items:flex-end;gap:8px;max-width:70%;animation:msgIn .2s ease}
    @keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .msg-wrap.sent{align-self:flex-end;flex-direction:row-reverse}
    .msg-wrap.recv{align-self:flex-start}
    .msg-avatar{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;overflow:hidden}
    .msg-content{display:flex;flex-direction:column;gap:2px}
    .msg-sender-name{font-size:11px;font-weight:700;margin-bottom:3px}
    .msg-bubble{padding:9px 13px;border-radius:14px;font-size:13.5px;line-height:1.5;word-break:break-word;position:relative;max-width:100%}
    .sent .msg-bubble{background:var(--sent-bg);border:1px solid var(--sent-border);border-bottom-right-radius:4px;color:var(--text)}
    .recv .msg-bubble{background:var(--recv-bg);border:1px solid var(--recv-border);border-bottom-left-radius:4px;color:var(--text)}
    .msg-meta{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--subtle);font-family:'Space Mono',monospace;margin-top:3px}
    .sent .msg-meta{justify-content:flex-end}
    .read-tick{color:var(--blue)}
    .edited-tag{font-size:10px;color:var(--subtle);font-style:italic}
    .fav-marker{color:var(--orange)}
    .msg-media img{max-width:220px;border-radius:10px;cursor:pointer;display:block}
    .msg-media audio,.msg-media video{max-width:240px;border-radius:8px}
    .msg-file{display:flex;align-items:center;gap:8px;color:var(--blue);font-size:13px;text-decoration:none}

    /* Context actions on hover */
    .msg-actions{display:none;position:absolute;top:-36px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:3px;gap:2px;flex-direction:row;box-shadow:0 4px 20px rgba(0,0,0,.5);z-index:10}
    .msg-bubble:hover .msg-actions,.msg-wrap:hover .msg-actions{display:flex}
    .sent .msg-actions{right:0}
    .recv .msg-actions{left:0}
    .ma-btn{width:28px;height:28px;border:none;border-radius:6px;background:transparent;color:var(--muted);cursor:pointer;font-size:13px;transition:all .15s;display:flex;align-items:center;justify-content:center}
    .ma-btn:hover{background:var(--surface2);color:var(--text)}

    /* Reactions */
    .msg-reactions{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px}
    .reaction-chip{background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:2px 7px;font-size:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:3px}
    .reaction-chip:hover{border-color:var(--green)}
    .reaction-chip small{font-size:10px;color:var(--muted)}

    /* Typing */
    .typing-ind{display:none;align-items:center;gap:8px;padding:4px 0;align-self:flex-start}
    .typing-ind.visible{display:flex}
    .typing-dots{display:flex;gap:4px;background:var(--recv-bg);border:1px solid var(--recv-border);border-radius:14px;border-bottom-left-radius:4px;padding:10px 14px}
    .typing-dots span{width:5px;height:5px;background:var(--muted);border-radius:50%;animation:bounce 1.2s infinite}
    .typing-dots span:nth-child(2){animation-delay:.2s}
    .typing-dots span:nth-child(3){animation-delay:.4s}
    @keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-5px);opacity:1}}

    /* ‚îÄ‚îÄ INPUT AREA ‚îÄ‚îÄ */
    .input-area{background:var(--surface);border-top:1px solid var(--border);padding:10px 14px;display:none;flex-direction:column;gap:8px;flex-shrink:0}
    .file-preview-bar{display:none;align-items:center;justify-content:space-between;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 12px;font-size:12px;color:var(--muted)}
    .file-preview-bar.visible{display:flex}
    .remove-fp{cursor:pointer;color:var(--red);font-size:14px;padding:2px}
    .input-row{display:flex;align-items:flex-end;gap:8px}
    .ia-btn{width:38px;height:38px;border:none;border-radius:9px;background:var(--bg);color:var(--muted);font-size:17px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .ia-btn:hover{background:var(--surface2);color:var(--text)}
    .input-box{flex:1;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:10px 14px;transition:border-color .2s;display:flex;align-items:center;min-height:40px}
    .input-box:focus-within{border-color:var(--green)}
    #msg-input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;resize:none;max-height:80px;overflow-y:auto;line-height:1.5}
    #msg-input::placeholder{color:var(--subtle)}
    .send-btn{width:42px;height:42px;background:var(--green);border:none;border-radius:11px;color:#000;font-size:17px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;flex-shrink:0}
    .send-btn:hover{background:var(--green-dark);transform:scale(1.05)}

    /* ‚îÄ‚îÄ EMOJI PICKER ‚îÄ‚îÄ */
    .emoji-picker{position:absolute;bottom:70px;left:14px;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:14px;width:310px;box-shadow:0 8px 40px rgba(0,0,0,.6);z-index:30;display:none}
    .emoji-picker.visible{display:block;animation:popUp .2s ease}
    @keyframes popUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .ep-tabs{display:flex;gap:4px;margin-bottom:10px;overflow-x:auto;padding-bottom:4px}
    .ep-tab{border:none;background:transparent;font-size:18px;padding:4px 8px;cursor:pointer;border-radius:7px;transition:all .15s;flex-shrink:0}
    .ep-tab:hover,.ep-tab.active{background:var(--surface2)}
    .ep-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:3px;max-height:160px;overflow-y:auto}
    .ep-grid::-webkit-scrollbar{width:3px}
    .ep-grid::-webkit-scrollbar-thumb{background:var(--border)}
    .ep-btn{border:none;background:transparent;font-size:20px;padding:5px;cursor:pointer;border-radius:7px;transition:all .1s}
    .ep-btn:hover{background:var(--surface2);transform:scale(1.2)}

    /* ‚îÄ‚îÄ ATTACH MENU ‚îÄ‚îÄ */
    .attach-menu{position:absolute;bottom:70px;left:58px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:6px;box-shadow:0 8px 40px rgba(0,0,0,.6);z-index:30;display:none;min-width:180px}
    .attach-menu.visible{display:block;animation:popUp .2s ease}
    .am-opt{display:flex;align-items:center;gap:10px;padding:10px 14px;border:none;background:transparent;width:100%;text-align:left;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;border-radius:9px;transition:all .15s}
    .am-opt:hover{background:var(--surface2)}
    .am-icon{font-size:20px;width:22px}

    /* ‚îÄ‚îÄ PROFILE PANEL ‚îÄ‚îÄ */
    .profile-panel{width:280px;background:var(--surface);border-left:1px solid var(--border);display:none;flex-direction:column;overflow-y:auto;flex-shrink:0}
    .profile-panel.visible{display:flex}
    .pp-bg{height:120px;background:linear-gradient(135deg,#0D2B1A,#091C10);display:flex;align-items:flex-end;padding:14px;position:relative;flex-shrink:0}
    .pp-close{position:absolute;top:10px;right:10px;width:30px;height:30px;border:none;border-radius:8px;background:rgba(0,0,0,.3);color:#fff;cursor:pointer;font-size:15px}
    .pp-avatar-wrap{padding:0 16px}
    .pp-big-avatar{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;border:3px solid var(--surface);margin-top:-36px;overflow:hidden;flex-shrink:0}
    .pp-body{padding:12px 16px}
    .pp-name{font-size:18px;font-weight:700;margin-top:6px}
    .pp-phone{font-size:12px;color:var(--muted);font-family:'Space Mono',monospace;margin-top:3px}
    .pp-section{margin-top:16px;padding:14px;background:var(--bg);border-radius:12px;border:1px solid var(--border)}
    .pp-section h4{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px}
    .pp-action{display:flex;align-items:center;gap:10px;width:100%;padding:9px 0;border:none;background:transparent;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;transition:color .15s;border-radius:8px}
    .pp-action:hover{color:var(--green)}
    .pp-action.danger:hover{color:var(--red)}
    .pp-action-icon{font-size:16px;width:22px;text-align:center}

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast-wrap{position:fixed;top:16px;right:16px;z-index:200;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--green);border-radius:12px;padding:12px 14px;min-width:260px;max-width:340px;display:flex;align-items:flex-start;gap:10px;box-shadow:0 8px 30px rgba(0,0,0,.5);pointer-events:all;cursor:pointer;animation:toastIn .3s ease;transition:all .3s}
    @keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
    .toast-icon{font-size:20px;flex-shrink:0;margin-top:1px}
    .toast-title{font-size:13px;font-weight:600}
    .toast-body{font-size:12px;color:var(--muted);margin-top:2px}

    /* ‚îÄ‚îÄ CALL OVERLAY ‚îÄ‚îÄ */
    .call-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:100;display:none;align-items:center;justify-content:center;flex-direction:column;gap:20px}
    .call-overlay.visible{display:flex;animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .call-icon-big{font-size:80px;animation:callPulse 1.5s ease-in-out infinite}
    @keyframes callPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
    .call-name{font-size:26px;font-weight:700}
    .call-status-text{font-size:15px;color:var(--muted)}
    .call-end-btn{width:64px;height:64px;background:var(--red);border:none;border-radius:50%;font-size:26px;cursor:pointer;transition:all .2s;margin-top:20px}
    .call-end-btn:hover{background:#cc3a48;transform:scale(1.1)}

    /* ‚îÄ‚îÄ CONTEXT MENU ‚îÄ‚îÄ */
    .ctx-menu{position:fixed;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:6px;min-width:180px;box-shadow:0 8px 40px rgba(0,0,0,.6);z-index:100;display:none}
    .ctx-menu.visible{display:block;animation:popUp .15s ease}
    .ctx-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border:none;background:transparent;width:100%;text-align:left;color:var(--text);font-family:'Sora',sans-serif;font-size:13px;cursor:pointer;border-radius:8px;transition:background .15s}
    .ctx-item:hover{background:var(--surface2)}
    .ctx-item.danger{color:var(--red)}

    @media(max-width:768px){
      .sidebar{position:absolute;inset:58px 0 0;z-index:10;width:100%!important}
      .profile-panel{position:absolute;inset:58px 0 0;z-index:11;width:100%!important}
      .topbar-search{display:none}
    }
  </style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <a href="index.html" class="topbar-logo">
    <div class="tl-icon">üí¨</div>
    <span class="tl-name">Papo<span>Reto</span></span>
  </a>
  <div class="nav-pill-wrap">
    <button class="nav-pill active" id="nav-chats" onclick="switchNav('chats')">üí¨ Chats
      <span class="pill-badge" id="badge-total" style="display:none">0</span>
    </button>
    <button class="nav-pill" id="nav-grupos" onclick="switchNav('grupos')">üë• Grupos</button>
    <button class="nav-pill" id="nav-status" onclick="switchNav('status')">üîµ Status</button>
  </div>
  <div class="topbar-right">
    <div class="topbar-search">
      <span style="font-size:14px;color:var(--muted)">üîç</span>
      <input type="text" placeholder="Pesquisar..." id="global-search" oninput="filterContacts()">
    </div>
    <button class="icon-btn" onclick="window.location.href='status.html'" title="Status">üîµ</button>
    <button class="icon-btn" onclick="window.location.href='grupo.html'" title="Grupos">üë•</button>
    <button class="icon-btn" onclick="window.location.href='configuracoes.html'" title="Configura√ß√µes">‚öôÔ∏è</button>
    <div class="my-avatar-btn" id="my-avatar" onclick="window.location.href='perfil.html'">?</div>
  </div>
</div>

<!-- APP BODY -->
<div class="app-body">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sb-header">
      <div class="sb-search">
        <input type="text" placeholder="Buscar contatos..." id="sb-search" oninput="filterContacts()">
      </div>
    </div>

    <!-- CHATS PANEL -->
    <div class="panel active" id="panel-chats">
      <div id="contacts-list"></div>
    </div>
    <!-- GRUPOS PANEL -->
    <div class="panel" id="panel-grupos">
      <div id="groups-sidebar-list"></div>
    </div>
    <!-- STATUS PANEL -->
    <div class="panel" id="panel-status">
      <div id="status-sidebar-list"></div>
    </div>

    <div class="sb-fab">
      <button onclick="showNewChatOptions()">+ Nova Conversa</button>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area" id="chat-area">
    <div class="chat-empty" id="chat-empty">
      <div class="empty-icon-wrap">üí¨</div>
      <h3 style="font-size:20px;font-weight:700;color:var(--text)">Bem-vindo ao PapoReto!</h3>
      <p style="font-size:14px;text-align:center;max-width:260px">Selecione uma conversa ao lado para come√ßar.</p>
    </div>

    <!-- CHAT HEADER -->
    <div class="chat-header" id="chat-header">
      <div class="ch-avatar" id="ch-avatar"></div>
      <div class="ch-info">
        <div class="ch-name" id="ch-name">‚Äî</div>
        <div class="ch-status" id="ch-status">offline</div>
      </div>
      <div class="ch-actions">
        <button class="icon-btn call-btn" onclick="startCall('voice')" title="Chamada">üìû</button>
        <button class="icon-btn call-btn" onclick="startCall('video')" title="V√≠deo">üìπ</button>
        <button class="icon-btn" onclick="toggleProfilePanel()" title="Info">‚ÑπÔ∏è</button>
        <button class="icon-btn" id="more-btn" onclick="showChatContextMenu(event)" title="Mais">‚ãÆ</button>
      </div>
    </div>

    <!-- MESSAGES -->
    <div class="messages-wrap" id="messages-wrap">
      <div class="typing-ind" id="typing-ind">
        <div class="msg-avatar" id="typing-avatar" style="font-size:12px"></div>
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>
    </div>

    <!-- FILE PREVIEW -->
    <div class="file-preview-bar" id="file-preview-bar">
      <span id="fp-name">üìé arquivo</span>
      <span class="remove-fp" onclick="clearFile()">‚úï Remover</span>
    </div>

    <!-- INPUT -->
    <div class="input-area" id="input-area">
      <div class="input-row">
        <button class="ia-btn" onclick="toggleEmoji()" title="Emoji">üòä</button>
        <button class="ia-btn" onclick="toggleAttach()" title="Anexar">üìé</button>
        <div class="input-box">
          <textarea id="msg-input" rows="1" placeholder="Digite uma mensagem..."
            oninput="handleTyping();autoResize(this)"
            onkeydown="handleKey(event)"></textarea>
        </div>
        <button class="send-btn" onclick="sendMsg()" title="Enviar">‚û§</button>
      </div>
    </div>

    <!-- EMOJI PICKER -->
    <div class="emoji-picker" id="emoji-picker">
      <div class="ep-tabs">
        <button class="ep-tab active" onclick="loadEmojis('smileys')">üòä</button>
        <button class="ep-tab" onclick="loadEmojis('hearts')">‚ù§Ô∏è</button>
        <button class="ep-tab" onclick="loadEmojis('hands')">üëã</button>
        <button class="ep-tab" onclick="loadEmojis('animals')">üê∂</button>
        <button class="ep-tab" onclick="loadEmojis('food')">üçï</button>
        <button class="ep-tab" onclick="loadEmojis('travel')">‚úàÔ∏è</button>
        <button class="ep-tab" onclick="loadEmojis('symbols')">üéâ</button>
      </div>
      <div class="ep-grid" id="ep-grid"></div>
    </div>

    <!-- ATTACH MENU -->
    <div class="attach-menu" id="attach-menu">
      <button class="am-opt" onclick="triggerUpload('image/*')"><span class="am-icon">üñºÔ∏è</span> Imagem / V√≠deo</button>
      <button class="am-opt" onclick="triggerUpload('audio/*')"><span class="am-icon">üéµ</span> √Åudio</button>
      <button class="am-opt" onclick="triggerUpload('application/*')"><span class="am-icon">üìÑ</span> Documento</button>
      <button class="am-opt" onclick="triggerUpload('*/*')"><span class="am-icon">üìÅ</span> Qualquer ficheiro</button>
    </div>
    <input type="file" id="file-input" style="display:none" onchange="handleFile(event)">
  </div>

  <!-- PROFILE PANEL -->
  <div class="profile-panel" id="profile-panel">
    <div class="pp-bg">
      <button class="pp-close" onclick="toggleProfilePanel()">‚úï</button>
    </div>
    <div class="pp-avatar-wrap">
      <div class="pp-big-avatar" id="pp-big-avatar"></div>
    </div>
    <div class="pp-body">
      <div class="pp-name" id="pp-name">‚Äî</div>
      <div class="pp-phone" id="pp-phone">‚Äî</div>
      <div class="pp-section">
        <h4>A√ß√µes</h4>
        <button class="pp-action" onclick="muteContact()"><span class="pp-action-icon">üîá</span> Silenciar</button>
        <button class="pp-action" onclick="archiveChat()"><span class="pp-action-icon">üì¶</span> Arquivar</button>
        <button class="pp-action danger" onclick="blockContact()"><span class="pp-action-icon">üö´</span> Bloquear</button>
        <button class="pp-action danger" onclick="reportContact()"><span class="pp-action-icon">‚ö†Ô∏è</span> Denunciar</button>
      </div>
    </div>
  </div>
</div>

<!-- CALL OVERLAY -->
<div class="call-overlay" id="call-overlay">
  <div class="call-icon-big" id="call-icon">üìû</div>
  <div class="call-name" id="call-name">‚Äî</div>
  <div class="call-status-text" id="call-status">Chamando...</div>
  <button class="call-end-btn" onclick="endCall()">üìµ</button>
</div>

<!-- CONTEXT MENU -->
<div class="ctx-menu" id="ctx-menu">
  <button class="ctx-item" onclick="archiveChat()">üì¶ Arquivar</button>
  <button class="ctx-item" onclick="muteContact()">üîá Silenciar</button>
  <button class="ctx-item" onclick="clearMessages()">üóëÔ∏è Limpar mensagens</button>
  <button class="ctx-item danger" onclick="blockContact()">üö´ Bloquear</button>
</div>

<!-- TOAST -->
<div class="toast-wrap" id="toast-wrap"></div>

<script>
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CONFIG & STATE (via config.js)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const DEMO = PR.IS_DEMO;

  let session = null;
  let currentChat = null;   // { type, id, name, phone }
  let allUsers = [];
  let allGroups = [];
  let msgMap = {};           // { chatKey: [msgs] }
  let typingTimeout = null;
  let callTimer = null;
  let selectedFile = null;
  let sbClient = null;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BOOT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.addEventListener('load', () => {
    session = PR.Session.require('login.html'); if (!session) return;

    document.getElementById('my-avatar').textContent = session.initials || '?';

    if (DEMO) loadDemoData();
    else initSupabase();

    initEmojis('smileys');
    requestNotifPermission();
  });

  // ‚îÄ‚îÄ‚îÄ DEMO DATA ‚îÄ‚îÄ‚îÄ
  function loadDemoData() {
    const stored = JSON.parse(localStorage.getItem('pr_users') || '[]');
    const defaults = [
      {id:'u1',name:'Amina Chissano',phone:'+258841234567',initials:'AC',color:'#00C16A',online:true},
      {id:'u2',name:'Carlos Mondlane',phone:'+258851234567',initials:'CM',color:'#58A6FF',online:false},
      {id:'u3',name:'Fatima Nhavene',phone:'+27831234567',initials:'FN',color:'#BC8CFF',online:false},
      {id:'u4',name:'Jo√£o Machava',phone:'+351912345678',initials:'JM',color:'#FF8C42',online:true},
      {id:'u5',name:'Sofia Zita',phone:'+238971234567',initials:'SZ',color:'#FF4757',online:false},
    ];
    allUsers = [...defaults, ...stored.filter(u => u.id !== session.id && u.id !== 'demo_user')];
    allGroups = [
      {id:'g1',name:'Fam√≠lia Maputo üè†',members:['u1','u2','u3']},
      {id:'g2',name:'Trabalho Dev üíª',members:['u1','u4','u5']},
    ];
    msgMap = {
      'user_u1':[
        {id:'m1',sender_id:'u1',content:'Ol√°! Tudo bem? üòä',type:'text',created_at:ago(7200),read:true},
        {id:'m2',sender_id:session.id,content:'Tudo √≥timo! E voc√™?',type:'text',created_at:ago(7100),read:true},
        {id:'m3',sender_id:'u1',content:'Tudo bem! Vai na festa amanh√£? üéâ',type:'text',created_at:ago(3600),read:true},
        {id:'m4',sender_id:session.id,content:'Com certeza! üî•',type:'text',created_at:ago(1800),read:true},
      ],
      'user_u2':[
        {id:'m5',sender_id:'u2',content:'Precisamos conversar sobre o projeto.',type:'text',created_at:ago(86400),read:false},
      ],
      'group_g1':[
        {id:'m6',sender_id:'u1',content:'Bom dia a todos! üåÖ',type:'text',created_at:ago(10800),read:true},
        {id:'m7',sender_id:'u2',content:'Bom dia! ‚òÄÔ∏è',type:'text',created_at:ago(9000),read:true},
        {id:'m8',sender_id:session.id,content:'Bom dia fam√≠lia! üè†',type:'text',created_at:ago(8000),read:true},
      ]
    };
    renderSidebar();
    renderGroupsSidebar();
    renderStatusSidebar();
    updateUnreadBadge();
  }

  function ago(s) { return PR_UTILS.ago(s); }

  // ‚îÄ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ‚îÄ
  function initSupabase() {
    loadSupabaseSDK((sb) => { sbClient = sb; loadContacts(); });
  }

  async function loadContacts() {
    try {
      allUsers = await PR.DB.getUsers(session.id);
      allGroups = await PR.DB.getGroups(session.id);
    } catch(e) { console.warn('loadContacts:', e); }
    renderSidebar(); renderGroupsSidebar(); renderStatusSidebar(); updateUnreadBadge();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SIDEBAR RENDER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function renderSidebar(filter='') {
    const list = document.getElementById('contacts-list');
    const q = filter.toLowerCase();
    const users = allUsers.filter(u => u.name.toLowerCase().includes(q) || (u.phone||'').includes(q));

    if (!users.length && !allGroups.length) {
      list.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:13px">Nenhum contato</div>`;
      return;
    }

    let html = '';

    // Show groups in chats panel too
    allGroups.filter(g=>g.name.toLowerCase().includes(q)).forEach(g => {
      const msgs = msgMap[`group_${g.id}`]||[];
      const last = msgs[msgs.length-1];
      const isActive = currentChat?.id===g.id && currentChat?.type==='group';
      html += `<div class="contact-item ${isActive?'active':''}" onclick="openChat('group','${g.id}','${esc(g.name)}','')">
        <div class="ci-avatar" style="background:rgba(188,140,255,0.15);color:var(--purple);font-size:20px">üë•</div>
        <div class="ci-info">
          <div class="ci-name">${esc(g.name)} <span class="group-tag">GRUPO</span></div>
          <div class="ci-preview">${last?(last.type!=='text'?'üìé M√≠dia':esc(last.content.substring(0,35))):'Grupo PapoReto'}</div>
        </div>
        <div class="ci-meta"><div class="ci-time">${last?fmtTime(last.created_at):''}</div></div>
      </div>`;
    });

    users.forEach(u => {
      const key = `user_${u.id}`;
      const msgs = msgMap[key]||[];
      const last = msgs[msgs.length-1];
      const unread = msgs.filter(m=>m.sender_id!==session.id&&!m.read).length;
      const isActive = currentChat?.id===u.id && currentChat?.type==='user';
      const isOnline = u.online || (u.last_seen && Date.now()-new Date(u.last_seen)<180000);
      html += `<div class="contact-item ${isActive?'active':''}" onclick="openChat('user','${u.id}','${esc(u.name)}','${esc(u.phone||'')}')">
        <div class="ci-avatar" style="background:${u.color||'var(--green)'}20;color:${u.color||'var(--green)'}">
          ${u.profile_url?`<img src="${u.profile_url}" alt="">`:u.initials||'?'}
          ${isOnline?'<div class="online-dot"></div>':''}
        </div>
        <div class="ci-info">
          <div class="ci-name">${esc(u.name)}</div>
          <div class="ci-preview">${last?(last.type!=='text'?'üìé M√≠dia':esc(last.content.substring(0,35))):u.phone||'PapoReto'}</div>
        </div>
        <div class="ci-meta">
          <div class="ci-time">${last?fmtTime(last.created_at):''}</div>
          ${unread?`<div class="unread">${unread}</div>`:''}
        </div>
      </div>`;
    });

    list.innerHTML = html || `<div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:13px">Sem resultados</div>`;
  }

  function renderGroupsSidebar() {
    const list = document.getElementById('groups-sidebar-list');
    if (!allGroups.length) {
      list.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--muted);font-size:13px">Nenhum grupo<br><a href="grupo.html" style="color:var(--green);font-size:12px;margin-top:8px;display:inline-block">+ Criar grupo</a></div>`;
      return;
    }
    list.innerHTML = allGroups.map(g => {
      const msgs = msgMap[`group_${g.id}`]||[];
      const last = msgs[msgs.length-1];
      return `<div class="contact-item" onclick="openChat('group','${g.id}','${esc(g.name)}','')">
        <div class="ci-avatar" style="background:rgba(188,140,255,0.15);color:var(--purple);font-size:20px">üë•</div>
        <div class="ci-info">
          <div class="ci-name">${esc(g.name)}</div>
          <div class="ci-preview">${last?esc(last.content.substring(0,35)):'Grupo PapoReto'}</div>
        </div>
        <div class="ci-meta"><div class="ci-time">${last?fmtTime(last.created_at):''}</div></div>
      </div>`;
    }).join('');
  }

  function renderStatusSidebar() {
    const list = document.getElementById('status-sidebar-list');
    list.innerHTML = `
      <div style="padding:14px">
        <div class="contact-item" style="padding:12px;background:rgba(0,193,106,0.04);border:1px solid rgba(0,193,106,0.1);border-radius:12px;cursor:pointer" onclick="window.location.href='status.html'">
          <div class="ci-avatar" style="background:rgba(0,193,106,0.15);color:var(--green);font-size:22px">‚ûï</div>
          <div class="ci-info">
            <div class="ci-name">Meu Status</div>
            <div class="ci-preview">Toque para adicionar status</div>
          </div>
        </div>
      </div>
      <div style="padding:0 14px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:8px">Recentes</div>
      ${allUsers.slice(0,4).map((u,i)=>`
        <div class="contact-item" onclick="viewStatus('${u.id}')">
          <div class="ci-avatar" style="background:${u.color||'var(--green)'}20;color:${u.color||'var(--green)'};border:2px solid ${i<2?'var(--green)':'var(--subtle)'}">
            ${u.initials||'?'}
          </div>
          <div class="ci-info">
            <div class="ci-name">${esc(u.name)}</div>
            <div class="ci-preview">${i<2?'üîµ Novo status':'Visto'}</div>
          </div>
          <div class="ci-meta"><div class="ci-time">${i<2?'Agora':fmtTime(ago(i*3600))}</div></div>
        </div>`).join('')}`;
  }

  function updateUnreadBadge() {
    let total = 0;
    Object.values(msgMap).forEach(msgs => {
      total += msgs.filter(m=>m.sender_id!==session.id&&!m.read).length;
    });
    const badge = document.getElementById('badge-total');
    badge.textContent = total;
    badge.style.display = total ? 'inline-block' : 'none';
  }

  function filterContacts() {
    const q = document.getElementById('global-search').value || document.getElementById('sb-search').value;
    renderSidebar(q);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // OPEN CHAT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function openChat(type, id, name, phone) {
    currentChat = {type,id,name,phone};

    // Show chat UI
    document.getElementById('chat-empty').style.display='none';
    document.getElementById('chat-header').style.display='flex';
    document.getElementById('messages-wrap').style.display='flex';
    document.getElementById('input-area').style.display='flex';

    document.getElementById('ch-name').textContent = name;

    // Set avatar in header
    const chAv = document.getElementById('ch-avatar');
    if (type==='group') {
      chAv.style.cssText='background:rgba(188,140,255,0.15);color:var(--purple);font-size:20px';
      chAv.innerHTML='üë•';
      document.getElementById('ch-status').textContent='Grupo';
      document.getElementById('ch-status').className='ch-status';
    } else {
      const u = allUsers.find(x=>x.id===id);
      const c = u?.color||strColor(id);
      chAv.style.cssText=`background:${c}20;color:${c};font-size:15px;font-weight:700`;
      chAv.innerHTML = u?.profile_url?`<img src="${u.profile_url}" style="width:100%;height:100%;object-fit:cover">`:(u?.initials||getInitials(name));
      const isOnline = u?.online;
      const st = document.getElementById('ch-status');
      st.textContent = isOnline?'online agora':(u?.last_seen?`visto ${fmtTime(u.last_seen)}`:'offline');
      st.className = `ch-status ${isOnline?'online':''}`;
    }

    // Profile panel
    document.getElementById('pp-name').textContent = name;
    document.getElementById('pp-phone').textContent = phone||'Grupo PapoReto';
    const ppAv = document.getElementById('pp-big-avatar');
    if (type==='group') {
      ppAv.style.cssText='background:rgba(188,140,255,0.15);color:var(--purple);font-size:28px;font-weight:400';
      ppAv.innerHTML='üë•';
    } else {
      const u = allUsers.find(x=>x.id===id);
      const c = u?.color||strColor(id);
      ppAv.style.cssText=`background:${c}20;color:${c};font-size:26px;font-weight:700`;
      ppAv.innerHTML = u?.initials||getInitials(name);
    }

    renderSidebar(document.getElementById('sb-search').value);
    loadMsgs();
    if (!DEMO && sbClient) subscribeRealtime();
    document.title = `PapoReto ‚Äî ${name}`;
    document.getElementById('msg-input').focus();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // MESSAGES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function loadMsgs() {
    if (DEMO) {
      renderMsgs(msgMap[chatKey()]||[]);
      return;
    }
    if (!sbClient) return;
    const q = currentChat.type==='user'
      ? sbClient.from('messages').select('*').or(`and(sender_id.eq.${session.id},receiver_id.eq.${currentChat.id}),and(sender_id.eq.${currentChat.id},receiver_id.eq.${session.id})`).order('created_at',{ascending:true})
      : sbClient.from('messages').select('*').eq('group_id',currentChat.id).order('created_at',{ascending:true});
    q.then(({data})=>{ if(data){msgMap[chatKey()]=data; renderMsgs(data);} });
  }

  function renderMsgs(msgs) {
    const wrap = document.getElementById('messages-wrap');
    const ind = document.getElementById('typing-ind');
    // Clear everything except typing indicator
    [...wrap.children].forEach(c=>{ if(c!==ind) c.remove(); });

    if (!msgs.length) {
      const el = document.createElement('div');
      el.style.cssText='text-align:center;padding:40px;color:var(--muted);font-size:13px;margin:auto';
      el.innerHTML='üîí Conversa segura. Diga ol√°!';
      wrap.insertBefore(el,ind);
      return;
    }

    let lastDate='';
    msgs.forEach(m => {
      const d = new Date(m.created_at).toLocaleDateString('pt-BR');
      if (d!==lastDate) {
        const divEl = document.createElement('div');
        divEl.className='date-div';
        divEl.innerHTML=`<span>${d===new Date().toLocaleDateString('pt-BR')?'Hoje':d}</span>`;
        wrap.insertBefore(divEl,ind);
        lastDate=d;
      }
      wrap.insertBefore(buildMsgEl(m),ind);
    });

    wrap.scrollTop=wrap.scrollHeight;
  }

  function buildMsgEl(m) {
    const isSent = m.sender_id===session.id;
    const u = allUsers.find(x=>x.id===m.sender_id);
    const c = u?.color||strColor(m.sender_id);
    const initials = u?.initials||getInitials(u?.name||'?');

    const wrap = document.createElement('div');
    wrap.className=`msg-wrap ${isSent?'sent':'recv'}`;
    wrap.dataset.id=m.id;

    const avatarHtml = isSent?'':`<div class="msg-avatar" style="background:${c}20;color:${c}">${initials}</div>`;

    // Content
    let content='';
    if (m.type==='image') content=`<div class="msg-media"><img src="${m.content}" alt="img" onclick="viewImg('${m.content}')"></div>`;
    else if (m.type==='audio') content=`<div class="msg-media"><audio controls><source src="${m.content}"></audio></div>`;
    else if (m.type==='video') content=`<div class="msg-media"><video controls style="max-width:220px;border-radius:8px"><source src="${m.content}"></video></div>`;
    else if (m.type==='file') content=`<a class="msg-file" href="${m.content}" target="_blank">üìÑ ${esc(m.file_name||'Arquivo')}</a>`;
    else content=`<div>${esc(m.content)}</div>`;

    const reactions = (m.reactions||[]).map(r=>`<div class="reaction-chip" onclick="quickReact('${m.id}','${r.emoji}')">${r.emoji}<small>${r.count||1}</small></div>`).join('');
    const editedTag = m.edited?'<span class="edited-tag"> (editado)</span>':'';
    const favIcon = m.favorite?'<span class="fav-marker">‚≠ê </span>':'';
    const tick = isSent?`<span class="${m.read?'read-tick':''}">  ${m.read?'‚úì‚úì':'‚úì'}</span>`:'';

    const actions = `<div class="msg-actions">
      <button class="ma-btn" onclick="quickReact('${m.id}','üòç')" title="Reagir">üòç</button>
      <button class="ma-btn" onclick="openReactionPicker('${m.id}')" title="Mais">üòä</button>
      ${isSent?`<button class="ma-btn" onclick="editMsg('${m.id}')" title="Editar">‚úèÔ∏è</button>`:''}
      <button class="ma-btn" onclick="toggleFav('${m.id}')" title="Fav">‚≠ê</button>
      ${isSent?`<button class="ma-btn" onclick="deleteMsg('${m.id}')" title="Apagar" style="color:var(--red)">üóëÔ∏è</button>`:''}
    </div>`;

    const senderName = (currentChat?.type==='group'&&!isSent)?`<div class="msg-sender-name" style="color:${c}">${esc(u?.name||'?')}</div>`:'';

    wrap.innerHTML=`${avatarHtml}
      <div class="msg-content">
        ${senderName}
        <div class="msg-bubble" style="position:relative">
          ${actions}
          ${favIcon}${content}${editedTag}
          <div class="msg-meta">
            <span>${fmtTime(m.created_at)}</span>${tick}
          </div>
        </div>
        ${reactions?`<div class="msg-reactions">${reactions}</div>`:''}
      </div>`;

    return wrap;
  }

  // ‚îÄ‚îÄ‚îÄ SEND ‚îÄ‚îÄ‚îÄ
  async function sendMsg() {
    if (selectedFile) { await sendFilMsg(); return; }
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if (!text || !currentChat) return;

    const m = {
      id:'msg_'+Date.now(), sender_id:session.id,
      content:text, type:'text',
      created_at:new Date().toISOString(), read:false,
      ...(currentChat.type==='user'?{receiver_id:currentChat.id}:{group_id:currentChat.id})
    };
    pushMsg(m);
    input.value=''; input.style.height='auto';
    renderSidebar(document.getElementById('sb-search').value);

    if (!DEMO) {
      try {
        const payload = {sender_id:session.id,content:text,type:'text',...(currentChat.type==='user'?{receiver_id:currentChat.id}:{group_id:currentChat.id})};
        const saved = await PR.DB.sendMessage(payload);
        if (saved?.id) { m.id = saved.id; }
      } catch(e) { console.warn('send:', e); }
    }
  }

  async function sendFilMsg() {
    if (!selectedFile||!currentChat) return;
    let type='file';
    if (selectedFile.type.startsWith('image/')) type='image';
    else if (selectedFile.type.startsWith('video/')) type='video';
    else if (selectedFile.type.startsWith('audio/')) type='audio';

    let url = URL.createObjectURL(selectedFile);

    if (!DEMO && sbClient) {
      const path = `${session.id}/${Date.now()}_${selectedFile.name}`;
      await sbClient.storage.from('media').upload(path,selectedFile);
      const {data:{publicUrl}} = sbClient.storage.from('media').getPublicUrl(path);
      url=publicUrl;
    }

    const m = {id:'msg_'+Date.now(),sender_id:session.id,content:url,type,file_name:selectedFile.name,created_at:new Date().toISOString(),read:false,...(currentChat.type==='user'?{receiver_id:currentChat.id}:{group_id:currentChat.id})};
    pushMsg(m);
    clearFile();
    if (!DEMO && sbClient) sbClient.from('messages').insert({sender_id:session.id,content:url,type,file_name:selectedFile.name,...(currentChat.type==='user'?{receiver_id:currentChat.id}:{group_id:currentChat.id})});
  }

  function pushMsg(m) {
    const key=chatKey();
    if (!msgMap[key]) msgMap[key]=[];
    msgMap[key].push(m);
    const wrap=document.getElementById('messages-wrap');
    const ind=document.getElementById('typing-ind');
    wrap.insertBefore(buildMsgEl(m),ind);
    wrap.scrollTop=wrap.scrollHeight;
  }

  function chatKey() { return `${currentChat.type}_${currentChat.id}`; }

  // ‚îÄ‚îÄ‚îÄ REALTIME ‚îÄ‚îÄ‚îÄ
  function subscribeRealtime() {
    if (!sbClient||!currentChat) return;
    sbClient.channel(`chat_${currentChat.id}`)
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:currentChat.type==='user'?`receiver_id=eq.${session.id}`:`group_id=eq.${currentChat.id}`},p=>{
        const m=p.new;
        if (m.sender_id===session.id) return;
        pushMsg(m);
        toast('üí¨',`Mensagem de ${allUsers.find(u=>u.id===m.sender_id)?.name||'?'}`,m.content.substring(0,40));
        sbClient.from('messages').update({read:true}).eq('id',m.id);
      })
      .on('postgres_changes',{event:'UPDATE',schema:'public',table:'typing_status',filter:`chat_id=eq.${currentChat.id}`},p=>{
        if (p.new.user_id===session.id) return;
        showTyping(p.new.typing);
      })
      .subscribe();
  }

  function showTyping(show) {
    const ind=document.getElementById('typing-ind');
    ind.classList.toggle('visible',show);
    if (show) { document.getElementById('messages-wrap').scrollTop=9999; const st=document.getElementById('ch-status'); st.textContent='digitando...'; st.className='ch-status typing'; }
    else { const u=allUsers.find(x=>x.id===currentChat?.id); const st=document.getElementById('ch-status'); st.textContent=u?.online?'online agora':'offline'; st.className=`ch-status ${u?.online?'online':''}`; }
  }

  // ‚îÄ‚îÄ‚îÄ TYPING ‚îÄ‚îÄ‚îÄ
  let isTyping=false;
  function handleTyping() {
    if (!sbClient||!currentChat) return;
    if (!isTyping) { isTyping=true; sbClient.from('typing_status').upsert({chat_id:currentChat.id,user_id:session.id,typing:true}); }
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>{ isTyping=false; sbClient?.from('typing_status').upsert({chat_id:currentChat.id,user_id:session.id,typing:false}); },2000);
  }

  // ‚îÄ‚îÄ‚îÄ MSG ACTIONS ‚îÄ‚îÄ‚îÄ
  function editMsg(id) {
    const m=findMsg(id);
    if (!m) return;
    const newContent=prompt('Editar mensagem:',m.content);
    if (!newContent||newContent===m.content) return;
    m.content=newContent; m.edited=true;
    refreshMsg(m);
    if (!DEMO&&sbClient) sbClient.from('messages').update({content:newContent,edited:true}).eq('id',id);
  }

  function deleteMsg(id) {
    if (!confirm('Apagar esta mensagem?')) return;
    const key=chatKey();
    const idx=msgMap[key]?.findIndex(m=>m.id===id);
    if (idx!==-1) msgMap[key].splice(idx,1);
    document.querySelector(`[data-id="${id}"]`)?.remove();
    if (!DEMO&&sbClient) sbClient.from('messages').delete().eq('id',id);
  }

  function toggleFav(id) {
    const m=findMsg(id);
    if (!m) return;
    m.favorite=!m.favorite;
    refreshMsg(m);
    toast(m.favorite?'‚≠ê':'üí´',m.favorite?'Marcado como favorito':'Removido dos favoritos','');
  }

  function quickReact(id,emoji) {
    const m=findMsg(id);
    if (!m) return;
    if (!m.reactions) m.reactions=[];
    const ex=m.reactions.find(r=>r.emoji===emoji&&r.user_id===session.id);
    if (ex) m.reactions=m.reactions.filter(r=>!(r.emoji===emoji&&r.user_id===session.id));
    else m.reactions.push({emoji,user_id:session.id,count:1});
    refreshMsg(m);
    if (!DEMO&&sbClient) sbClient.from('message_reactions').upsert({message_id:id,user_id:session.id,emoji});
  }

  function openReactionPicker(id) {
    const emojis=['üòç','üòÇ','üëç','‚ù§Ô∏è','üî•','üò¢','üëè','üéâ'];
    const em=prompt('Escolha uma rea√ß√£o:\n'+emojis.map((e,i)=>`${i+1}. ${e}`).join('\n'));
    if (!em) return;
    const idx=parseInt(em)-1;
    if (emojis[idx]) quickReact(id,emojis[idx]);
  }

  function findMsg(id) {
    const key=chatKey();
    return msgMap[key]?.find(m=>m.id===id);
  }

  function refreshMsg(m) {
    const old=document.querySelector(`[data-id="${m.id}"]`);
    if (!old) return;
    const newEl=buildMsgEl(m);
    old.replaceWith(newEl);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // EMOJI
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const EMOJI_SETS = {
    smileys:['üòÄ','üòÇ','ü•∞','üòç','ü§©','üòé','ü•≥','üòä','üòá','ü§ó','üòè','üòí','üò¢','üò≠','üò§','üò†','ü§¨','üò±','ü§î','üò¥','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§†','ü•∏','üòà','üëª','üíÄ','üôä','üôâ','üôà','ü´†','ü•∫','üòÖ','ü§£','ü´°','ü§≠'],
    hearts:['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','üíï','üíû','üíì','üíó','üíñ','üíù','üíò','üíü','‚ù£Ô∏è','‚ô•Ô∏è','ü´∂','‚ù§Ô∏è‚Äçüî•'],
    hands:['üëã','ü§ö','üñê','‚úã','üññ','ü´±','ü´≤','ü´≥','ü´¥','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü´∞','ü§ô','üëà','üëâ','üëÜ','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','ü´∂','ü§≤','üôè'],
    animals:['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','ü¶Ü','ü¶Ö','ü¶â','ü¶ã','üêù','üêõ','ü¶é','üêç','üê¢','ü¶ï','ü¶ñ','üêô','ü¶ë','ü¶ê','ü¶û'],
    food:['üçï','üçî','üçü','üåÆ','üåØ','ü•ô','üßÜ','ü•ö','üç≥','ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','ü•™','ü•ó','ü•ò','üçù','üçú','üç≤','üçõ','üç£','üç±','üç±','‚òï','üßÉ','ü•§','üßã','üç∫','ü•Ç','üç∑'],
    travel:['‚úàÔ∏è','üöÄ','üõ∏','üöÇ','üö¢','üöó','üèéÔ∏è','üöï','üõª','üöå','üèçÔ∏è','üõµ','üö≤','üõ∫','üöÅ','‚õµ','üèñÔ∏è','üèîÔ∏è','üóª','üåã','üèïÔ∏è','üåÖ','üåÑ','üóº','üóΩ','üè∞','üé°','üé¢'],
    symbols:['üéâ','üéä','üéà','üéÅ','üé∂','üéµ','üé∏','üéπ','üèÜ','‚≠ê','‚ú®','üí´','üî•','üí•','‚ùÑÔ∏è','üåà','üåä','üíé','üí∞','üîë','üéØ','üé™','üé≠','üé®','üñºÔ∏è','üì±','üíª','üñ•Ô∏è','‚åö','üîî','üì£','üí°']
  };

  function initEmojis(cat) {
    loadEmojis(cat||'smileys');
  }

  function loadEmojis(cat) {
    const grid=document.getElementById('ep-grid');
    const emojis=EMOJI_SETS[cat]||EMOJI_SETS.smileys;
    grid.innerHTML=emojis.map(e=>`<button class="ep-btn" onclick="insertEmoji('${e}')">${e}</button>`).join('');
    document.querySelectorAll('.ep-tab').forEach(t=>t.classList.remove('active'));
  }

  function toggleEmoji() {
    const p=document.getElementById('emoji-picker');
    p.classList.toggle('visible');
    if (p.classList.contains('visible')) { document.getElementById('attach-menu').classList.remove('visible'); loadEmojis('smileys'); }
  }

  function insertEmoji(e) {
    const inp=document.getElementById('msg-input');
    const pos=inp.selectionStart;
    inp.value=inp.value.slice(0,pos)+e+inp.value.slice(pos);
    inp.focus(); inp.selectionStart=inp.selectionEnd=pos+e.length;
    document.getElementById('emoji-picker').classList.remove('visible');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FILE UPLOAD
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function toggleAttach() {
    document.getElementById('attach-menu').classList.toggle('visible');
    document.getElementById('emoji-picker').classList.remove('visible');
  }

  function triggerUpload(accept) {
    const inp=document.getElementById('file-input');
    inp.accept=accept; inp.click();
    document.getElementById('attach-menu').classList.remove('visible');
  }

  function handleFile(e) {
    const f=e.target.files[0];
    if (!f) return;
    selectedFile=f;
    const bar=document.getElementById('file-preview-bar');
    document.getElementById('fp-name').textContent=`üìé ${f.name} (${(f.size/1024).toFixed(1)} KB)`;
    bar.classList.add('visible');
  }

  function clearFile() {
    selectedFile=null;
    document.getElementById('file-input').value='';
    document.getElementById('file-preview-bar').classList.remove('visible');
  }

  function viewImg(src) {
    const ov=document.createElement('div');
    ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:500;display:flex;align-items:center;justify-content:center;cursor:zoom-out';
    ov.innerHTML=`<img src="${src}" style="max-width:90vw;max-height:90vh;border-radius:12px;object-fit:contain">`;
    ov.onclick=()=>ov.remove();
    document.body.appendChild(ov);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // CALLS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function startCall(type) {
    if (!currentChat) return;
    const ov=document.getElementById('call-overlay');
    document.getElementById('call-icon').textContent=type==='video'?'üìπ':'üìû';
    document.getElementById('call-name').textContent=currentChat.name;
    document.getElementById('call-status').textContent='Chamando...';
    ov.classList.add('visible');
    setTimeout(()=>{ if(ov.classList.contains('visible')){ document.getElementById('call-status').textContent='Conectado ‚Ä¢ 00:00'; startCallTimer(); }},2000);
    if (!DEMO&&sbClient) {
      sbClient.channel(`call_${currentChat.id}`).send({type:'broadcast',event:'call',payload:{caller:session.id,type}});
    }
  }

  let callSecs=0;
  function startCallTimer() {
    callSecs=0; clearInterval(callTimer);
    callTimer=setInterval(()=>{ callSecs++; const m=String(Math.floor(callSecs/60)).padStart(2,'0'); const s=String(callSecs%60).padStart(2,'0'); const el=document.getElementById('call-status'); if(el) el.textContent=`Conectado ‚Ä¢ ${m}:${s}`; },1000);
  }

  function endCall() { clearInterval(callTimer); document.getElementById('call-overlay').classList.remove('visible'); toast('üìµ','Chamada encerrada',`Dura√ß√£o: ${String(Math.floor(callSecs/60)).padStart(2,'0')}:${String(callSecs%60).padStart(2,'0')}`); }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // PROFILE PANEL / ACTIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function toggleProfilePanel() { document.getElementById('profile-panel').classList.toggle('visible'); }

  function blockContact() {
    if (!currentChat) return;
    if (!confirm(`Bloquear ${currentChat.name}?`)) return;
    if (!DEMO) PR.DB.blockUser(session.id, currentChat.id).catch(()=>{});
    toast('üö´','Bloqueado',`${currentChat.name} foi bloqueado.`);
    document.getElementById('profile-panel').classList.remove('visible');
  }

  function reportContact() { toast('‚ö†Ô∏è','Den√∫ncia enviada','Vamos analisar em breve. Obrigado!'); }

  function archiveChat() {
    if (!currentChat) return;
    if (!DEMO) PR.DB.updateMessage && console.log('archived');
    toast('üì¶','Conversa arquivada','Pode encontrar em Arquivados.');
    document.getElementById('profile-panel').classList.remove('visible');
  }

  function muteContact() { toast('üîá','Silenciado','Notifica√ß√µes silenciadas por 8 horas.'); }

  function clearMessages() {
    if (!currentChat||!confirm('Limpar todas as mensagens?')) return;
    msgMap[chatKey()]=[];
    renderMsgs([]);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // NAV / PANELS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function switchNav(nav) {
    ['chats','grupos','status'].forEach(n=>{
      document.getElementById(`nav-${n}`).classList.toggle('active',n===nav);
      document.getElementById(`panel-${n}`).classList.toggle('active',n===nav);
    });
  }

  function showChatContextMenu(e) {
    const menu=document.getElementById('ctx-menu');
    menu.style.top=(e.clientY+8)+'px';
    menu.style.left=(e.clientX-menu.offsetWidth||180)+'px';
    menu.classList.toggle('visible');
  }

  function showNewChatOptions() {
    if (DEMO) toast('‚ÑπÔ∏è','Novo chat','No modo demo todos os contatos j√° aparecem na lista.');
    else window.location.href='perfil.html';
  }

  function viewStatus(id) {
    const u=allUsers.find(x=>x.id===id);
    toast('üëÅÔ∏è',`Status de ${u?.name||'?'}`, 'Status visualizado!');
    window.location.href='status.html';
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // UTILS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function getInitials(name) { return PR_UTILS.getInitials(name); }
  function strColor(s) { return PR_UTILS.strColor(s); }
  function esc(s) { return PR_UTILS.esc(s); }
  function fmtTime(iso) { return PR_UTILS.fmtTime(iso); }

  function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,80)+'px'; }

  function handleKey(e) { if (e.key==='Enter'&&!e.shiftKey) { e.preventDefault(); sendMsg(); } }

  // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
  function toast(icon,title,body) {
    const wrap=document.getElementById('toast-wrap');
    const t=document.createElement('div');
    t.className='toast';
    t.innerHTML=`<div class="toast-icon">${icon}</div><div><div class="toast-title">${title}</div>${body?`<div class="toast-body">${body}</div>`:''}</div>`;
    t.onclick=()=>t.remove();
    wrap.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateX(30px)'; setTimeout(()=>t.remove(),300); },4000);
  }

  // ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ
  function requestNotifPermission() {
    if ('Notification' in window && Notification.permission==='default') {
      setTimeout(()=>Notification.requestPermission(),3000);
    }
  }

  // Close popups on outside click
  document.addEventListener('click', e => {
    if (!e.target.closest('#emoji-picker')&&!e.target.closest('.ia-btn')) document.getElementById('emoji-picker')?.classList.remove('visible');
    if (!e.target.closest('#attach-menu')&&!e.target.closest('.ia-btn')) document.getElementById('attach-menu')?.classList.remove('visible');
    if (!e.target.closest('#ctx-menu')&&!e.target.closest('#more-btn')) document.getElementById('ctx-menu')?.classList.remove('visible');
  });

  document.addEventListener('keydown', e => {
    if (e.key==='Escape') {
      document.querySelectorAll('.emoji-picker,.attach-menu').forEach(el=>el.classList.remove('visible'));
      document.getElementById('call-overlay')?.classList.remove('visible');
      clearInterval(callTimer);
    }
  });
</script>
</body>
</html>
