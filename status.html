<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PapoReto ‚Äî Status</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--green:#00C16A;--green-dark:#009E56;--green-glow:rgba(0,193,106,.2);--bg:#0A0F14;--surface:#111820;--surface2:#19232F;--border:#1E2A38;--text:#E8F0F8;--muted:#6B7F94;--subtle:#2E3D50;--red:#FF4757;--orange:#FF8C42;--purple:#BC8CFF;--blue:#58A6FF}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

    .topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:58px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:20}
    .back-btn{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);text-decoration:none;transition:color .2s;padding:8px 14px;border-radius:9px;background:transparent;border:none;cursor:pointer;font-family:'Sora',sans-serif}
    .back-btn:hover{color:var(--text);background:var(--surface2)}
    .page-title{font-size:17px;font-weight:700}
    .topbar-right{margin-left:auto}
    .btn-sm{padding:9px 18px;border:none;border-radius:10px;font-family:'Sora',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
    .btn-sm.primary{background:var(--green);color:#000}
    .btn-sm.primary:hover{background:var(--green-dark)}

    .page-layout{display:grid;grid-template-columns:340px 1fr;height:calc(100vh - 58px)}
    @media(max-width:768px){.page-layout{grid-template-columns:1fr;height:auto}}

    /* LEFT PANEL */
    .left-panel{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}

    .my-status-btn{display:flex;align-items:center;gap:12px;padding:16px;cursor:pointer;transition:all .2s;border-bottom:1px solid var(--border)}
    .my-status-btn:hover{background:var(--surface2)}
    .add-status-ring{width:52px;height:52px;border-radius:50%;border:2.5px dashed var(--green);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;position:relative}
    .add-status-ring::after{content:'+';position:absolute;bottom:-2px;right:-2px;width:20px;height:20px;background:var(--green);border-radius:50%;font-size:14px;font-weight:700;color:#000;display:flex;align-items:center;justify-content:center;border:2px solid var(--surface)}
    .msi{flex:1}
    .msi-title{font-size:14px;font-weight:600}
    .msi-sub{font-size:12px;color:var(--muted);margin-top:2px}

    .status-section-label{padding:12px 16px 6px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:700;font-family:'Space Mono',monospace}

    .status-item{display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;transition:all .2s}
    .status-item:hover{background:var(--surface2)}
    .status-item.active{background:var(--surface2);border-left:3px solid var(--green)}

    .status-ring{width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;flex-shrink:0;position:relative;overflow:hidden}
    .status-ring::before{content:'';position:absolute;inset:-3px;border-radius:50%;padding:3px;background:conic-gradient(var(--green) var(--prog,100%),var(--subtle) 0);-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
    .status-ring.seen::before{background:conic-gradient(var(--subtle) 100%,var(--subtle) 0)}
    .status-inner{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;overflow:hidden;border:2px solid var(--surface)}
    .status-inner img{width:100%;height:100%;object-fit:cover}

    .si-info{flex:1}
    .si-name{font-size:14px;font-weight:600}
    .si-preview{font-size:12px;color:var(--muted);margin-top:2px}
    .si-time{font-size:11px;color:var(--subtle);font-family:'Space Mono',monospace}

    /* RIGHT PANEL - VIEWER */
    .viewer{background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden}
    .viewer-empty{text-align:center;color:var(--muted)}
    .viewer-empty .ve-icon{font-size:64px;margin-bottom:16px;opacity:.3}
    .viewer-empty h3{font-size:20px;font-weight:700;color:var(--text);margin-bottom:8px}

    /* Story viewer */
    .story-viewer{position:relative;width:100%;height:100%;display:none;flex-direction:column}
    .story-viewer.visible{display:flex}

    /* Progress bars */
    .story-bars{display:flex;gap:4px;padding:16px 16px 8px;position:absolute;top:0;left:0;right:0;z-index:10}
    .story-bar{flex:1;height:3px;background:rgba(255,255,255,.3);border-radius:2px;overflow:hidden}
    .story-bar-fill{height:100%;background:#fff;border-radius:2px;width:0%;transition:none}
    .story-bar-fill.done{width:100%}
    .story-bar-fill.active{animation:progress var(--dur,5s) linear forwards}
    @keyframes progress{from{width:0%}to{width:100%}}

    /* Story header */
    .story-header{position:absolute;top:28px;left:0;right:0;display:flex;align-items:center;gap:12px;padding:0 16px;z-index:10}
    .story-user-av{width:40px;height:40px;border-radius:50%;border:2px solid #fff;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;flex-shrink:0}
    .story-user-info{flex:1}
    .story-user-name{font-size:14px;font-weight:600;color:#fff;text-shadow:0 1px 6px rgba(0,0,0,.8)}
    .story-user-time{font-size:11px;color:rgba(255,255,255,.7);font-family:'Space Mono',monospace}
    .story-close-btn{width:34px;height:34px;border:none;border-radius:50%;background:rgba(0,0,0,.4);color:#fff;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}

    /* Story content area */
    .story-bg{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .story-bg img,.story-bg video{width:100%;height:100%;object-fit:cover}
    .story-text-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:40px;text-align:center;font-size:clamp(18px,3vw,28px);font-weight:700;line-height:1.4;color:#fff;text-shadow:0 2px 12px rgba(0,0,0,.8)}

    /* Story gradient */
    .story-bg::after{content:'';position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,.4) 0%,transparent 30%,transparent 70%,rgba(0,0,0,.6) 100%)}

    /* Nav arrows */
    .story-nav{position:absolute;inset:0;display:flex;z-index:5}
    .story-nav-prev,.story-nav-next{flex:1;cursor:pointer;display:flex;align-items:center}
    .story-nav-prev{justify-content:flex-start;padding-left:12px}
    .story-nav-next{justify-content:flex-end;padding-right:12px}
    .nav-arrow{width:40px;height:40px;background:rgba(0,0,0,.3);border:none;border-radius:50%;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);transition:all .2s}
    .nav-arrow:hover{background:rgba(0,0,0,.6)}

    /* Story reactions */
    .story-footer{position:absolute;bottom:0;left:0;right:0;padding:16px;z-index:10;display:flex;align-items:center;gap:10px}
    .story-reply-input{flex:1;padding:10px 14px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:24px;color:#fff;font-family:'Sora',sans-serif;font-size:13px;outline:none;backdrop-filter:blur(8px)}
    .story-reply-input::placeholder{color:rgba(255,255,255,.6)}
    .story-emoji-row{display:flex;gap:6px}
    .se-btn{font-size:22px;cursor:pointer;transition:transform .15s;background:none;border:none;filter:drop-shadow(0 1px 4px rgba(0,0,0,.5))}
    .se-btn:hover{transform:scale(1.3)}

    /* Create status overlay */
    .create-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:100;display:none;align-items:center;justify-content:center}
    .create-overlay.visible{display:flex;animation:fadeIn .2s ease}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .create-card{background:var(--surface);border:1px solid var(--border);border-radius:24px;padding:32px;width:480px;box-shadow:0 20px 60px rgba(0,0,0,.6);animation:slideUp .2s ease}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .cc-title{font-size:20px;font-weight:800;margin-bottom:20px}
    .cc-tabs{display:flex;background:var(--bg);border-radius:10px;padding:3px;gap:2px;margin-bottom:20px}
    .cc-tab{flex:1;padding:9px;border:none;border-radius:8px;font-family:'Sora',sans-serif;font-size:13px;font-weight:500;cursor:pointer;background:transparent;color:var(--muted);transition:all .2s}
    .cc-tab.active{background:var(--green);color:#000;font-weight:700}
    .fg{margin-bottom:16px}
    .fg label{display:block;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px}
    .fg input,.fg select,.fg textarea{width:100%;padding:11px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:11px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;outline:none;transition:all .2s}
    .fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--green)}
    .fg textarea{min-height:90px;resize:vertical;line-height:1.6}
    .fg input::placeholder,.fg textarea::placeholder{color:var(--subtle)}
    .color-row{display:flex;gap:8px;flex-wrap:wrap}
    .color-swatch{width:32px;height:32px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .2s}
    .color-swatch.active{border-color:#fff;transform:scale(1.1)}
    .btn-row{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
    .btn-cancel{padding:10px 20px;background:transparent;border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'Sora',sans-serif;font-size:14px;cursor:pointer;transition:all .2s}
    .btn-cancel:hover{border-color:var(--muted)}
    .btn-publish{padding:10px 24px;background:var(--green);border:none;border-radius:10px;color:#000;font-family:'Sora',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s}
    .btn-publish:hover{background:var(--green-dark)}

    .toast-wrap{position:fixed;top:16px;right:16px;z-index:200;display:flex;flex-direction:column;gap:8px;pointer-events:none}
    .toast{background:var(--surface);border:1px solid var(--border);border-left:4px solid var(--green);border-radius:12px;padding:12px 14px;min-width:260px;display:flex;align-items:flex-start;gap:10px;box-shadow:0 8px 30px rgba(0,0,0,.5);pointer-events:all;cursor:pointer;animation:toastIn .3s ease}
    @keyframes toastIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
    .toast-icon{font-size:20px;flex-shrink:0}
    .toast-title{font-size:13px;font-weight:600}
    .toast-body{font-size:12px;color:var(--muted);margin-top:2px}
  </style>
</head>
<body>

<div class="topbar">
  <button class="back-btn" onclick="window.location.href='chat.html'">‚Üê Voltar</button>
  <div class="page-title">üîµ Status</div>
  <div class="topbar-right">
    <button class="btn-sm primary" onclick="openCreate()">+ Criar Status</button>
  </div>
</div>

<div class="page-layout">

  <!-- LEFT: STATUS LIST -->
  <div class="left-panel">
    <!-- My status -->
    <div class="my-status-btn" onclick="openCreate()">
      <div class="add-status-ring">üòä</div>
      <div class="msi">
        <div class="msi-title">Meu Status</div>
        <div class="msi-sub">Toque para adicionar status</div>
      </div>
    </div>

    <!-- Recent statuses -->
    <div class="status-section-label">Recentes</div>
    <div id="statuses-list" style="flex:1;overflow-y:auto">
      <!-- rendered by JS -->
    </div>

    <!-- Viewed statuses -->
    <div class="status-section-label" id="viewed-label" style="display:none">Vistos</div>
    <div id="viewed-list">
      <!-- rendered by JS -->
    </div>
  </div>

  <!-- RIGHT: VIEWER -->
  <div class="viewer" id="viewer">
    <div class="viewer-empty" id="viewer-empty">
      <div class="ve-icon">üîµ</div>
      <h3>Status</h3>
      <p style="font-size:14px;max-width:240px;line-height:1.6">Clique num status ao lado para visualizar.</p>
    </div>

    <!-- Story viewer -->
    <div class="story-viewer" id="story-viewer">
      <!-- Progress bars -->
      <div class="story-bars" id="story-bars"></div>

      <!-- Header -->
      <div class="story-header">
        <div class="story-user-av" id="sv-avatar"></div>
        <div class="story-user-info">
          <div class="story-user-name" id="sv-name">‚Äî</div>
          <div class="story-user-time" id="sv-time">Agora</div>
        </div>
        <button class="story-close-btn" onclick="closeViewer()">‚úï</button>
      </div>

      <!-- BG content -->
      <div class="story-bg" id="story-bg"></div>
      <div class="story-text-overlay" id="story-text"></div>

      <!-- Navigation -->
      <div class="story-nav">
        <div class="story-nav-prev" onclick="prevStory()">
          <button class="nav-arrow">‚Äπ</button>
        </div>
        <div class="story-nav-next" onclick="nextStory()">
          <button class="nav-arrow">‚Ä∫</button>
        </div>
      </div>

      <!-- Footer -->
      <div class="story-footer">
        <input type="text" class="story-reply-input" placeholder="Responder ao status...">
        <div class="story-emoji-row">
          <button class="se-btn" onclick="reactStory('‚ù§Ô∏è')">‚ù§Ô∏è</button>
          <button class="se-btn" onclick="reactStory('üòÇ')">üòÇ</button>
          <button class="se-btn" onclick="reactStory('üòÆ')">üòÆ</button>
          <button class="se-btn" onclick="reactStory('üëè')">üëè</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CREATE STATUS OVERLAY -->
<div class="create-overlay" id="create-overlay">
  <div class="create-card">
    <div class="cc-title">‚ú¶ Novo Status</div>

    <div class="cc-tabs">
      <button class="cc-tab active" onclick="switchCreateTab('text')">üìù Texto</button>
      <button class="cc-tab" onclick="switchCreateTab('image')">üñºÔ∏è Imagem</button>
      <button class="cc-tab" onclick="switchCreateTab('video')">üé¨ V√≠deo</button>
    </div>

    <!-- Text tab -->
    <div id="tab-text">
      <div class="fg">
        <label>Mensagem</label>
        <textarea id="status-text" placeholder="O que est√° acontecendo? üåü" maxlength="280"></textarea>
        <div style="font-size:11px;color:var(--subtle);text-align:right;margin-top:4px"><span id="char-count">0</span>/280</div>
      </div>
      <div class="fg">
        <label>Cor de fundo</label>
        <div class="color-row" id="color-row"></div>
      </div>
      <div class="fg">
        <label>Emoji decorativo</label>
        <input type="text" id="status-emoji" placeholder="Ex: üéâ" maxlength="2" style="font-size:22px;text-align:center;width:60px">
      </div>
    </div>

    <!-- Image/Video tab -->
    <div id="tab-image" style="display:none">
      <div style="border:2px dashed var(--border);border-radius:14px;padding:36px;text-align:center;cursor:pointer;transition:all .2s" id="drop-zone" onclick="document.getElementById('media-input').click()">
        <div style="font-size:42px;margin-bottom:10px">üñºÔ∏è</div>
        <div style="font-size:14px;color:var(--muted)">Clique ou arraste uma imagem aqui</div>
        <div style="font-size:12px;color:var(--subtle);margin-top:6px">JPG, PNG, GIF, WEBP ‚Äî m√°x. 10MB</div>
      </div>
      <input type="file" id="media-input" accept="image/*,video/*" style="display:none" onchange="handleMediaSelect(event)">
      <div id="media-preview" style="margin-top:12px;display:none"></div>
    </div>

    <div id="tab-video" style="display:none">
      <div style="border:2px dashed var(--border);border-radius:14px;padding:36px;text-align:center;cursor:pointer" onclick="document.getElementById('video-input').click()">
        <div style="font-size:42px;margin-bottom:10px">üé¨</div>
        <div style="font-size:14px;color:var(--muted)">Selecionar v√≠deo</div>
        <div style="font-size:12px;color:var(--subtle);margin-top:6px">MP4, WEBM ‚Äî m√°x. 50MB</div>
      </div>
      <input type="file" id="video-input" accept="video/*" style="display:none" onchange="handleVideoSelect(event)">
    </div>

    <div class="btn-row">
      <button class="btn-cancel" onclick="closeCreate()">Cancelar</button>
      <button class="btn-publish" onclick="publishStatus()">üîµ Publicar Status</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toast-wrap"></div>

<script>
  const COLORS = ['#1a3a2a','#0D1B2A','#2D1B69','#1A1A2E','#16213E','#0F3460','#1B1B2F','#2C1654'];
  let session=null, allStatuses=[], viewingIdx=0, viewingUser=null, storyTimer=null;
  let selectedBg=COLORS[0], selectedMedia=null, createTab='text';

  window.addEventListener('load',()=>{
    const raw=localStorage.getItem('pr_session');
    if(!raw){window.location.href='login.html';return;}
    session=JSON.parse(raw);
    renderColorRow();
    loadStatuses();
    setupDrag();
  });

  function loadStatuses(){
    const stored=JSON.parse(localStorage.getItem('pr_statuses')||'[]');
    const now=Date.now();
    // Filter expired (>24h)
    const fresh=stored.filter(s=>now-new Date(s.created_at)<86400000);
    if(fresh.length!==stored.length) localStorage.setItem('pr_statuses',JSON.stringify(fresh));

    const defaultStatuses=[
      {id:'s1',user_id:'u1',user_name:'Amina Chissano',user_initials:'AC',user_color:'#00C16A',type:'text',content:'Boa tarde a todos! ‚òÄÔ∏è',bg:COLORS[0],emoji:'‚òÄÔ∏è',created_at:new Date(Date.now()-1800000).toISOString(),seen:false},
      {id:'s2',user_id:'u2',user_name:'Carlos Mondlane',user_initials:'CM',user_color:'#58A6FF',type:'text',content:'A vida √© bela quando voc√™ tem objetivos üéØ',bg:COLORS[1],emoji:'üéØ',created_at:new Date(Date.now()-7200000).toISOString(),seen:false},
      {id:'s3',user_id:'u3',user_name:'Fatima Nhavene',user_initials:'FN',user_color:'#BC8CFF',type:'text',content:'Finalmente de f√©rias! üèñÔ∏èüå¥',bg:COLORS[3],emoji:'üèñÔ∏è',created_at:new Date(Date.now()-10800000).toISOString(),seen:true},
      {id:'s4',user_id:'u4',user_name:'Jo√£o Machava',user_initials:'JM',user_color:'#FF8C42',type:'text',content:'Novo projeto em andamento üíªüöÄ',bg:COLORS[2],emoji:'üöÄ',created_at:new Date(Date.now()-18000000).toISOString(),seen:true},
    ];

    allStatuses=[...defaultStatuses,...fresh];
    renderStatusList();
  }

  function renderStatusList(){
    const fresh=allStatuses.filter(s=>!s.seen);
    const seen=allStatuses.filter(s=>s.seen);

    const list=document.getElementById('statuses-list');
    list.innerHTML=fresh.map((s,i)=>`
      <div class="status-item ${i===viewingIdx&&viewingUser===s.user_id?'active':''}" onclick="viewStatus('${s.user_id}',${allStatuses.indexOf(s)})">
        <div class="status-ring" style="--prog:100%">
          <div class="status-inner" style="background:${s.user_color}20;color:${s.user_color};font-size:16px;font-weight:700">${s.user_initials}</div>
        </div>
        <div class="si-info">
          <div class="si-name">${esc(s.user_name)}</div>
          <div class="si-preview">${esc(s.content.substring(0,40))}</div>
        </div>
        <div class="si-time">${fmtTime(s.created_at)}</div>
      </div>`).join('')||'<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px">Nenhum status novo</div>';

    const viewedList=document.getElementById('viewed-list');
    const viewedLabel=document.getElementById('viewed-label');
    if(seen.length){
      viewedLabel.style.display='block';
      viewedList.innerHTML=seen.map(s=>`
        <div class="status-item" onclick="viewStatus('${s.user_id}',${allStatuses.indexOf(s)})">
          <div class="status-ring seen">
            <div class="status-inner" style="background:${s.user_color}20;color:${s.user_color};font-size:16px;font-weight:700;opacity:.6">${s.user_initials}</div>
          </div>
          <div class="si-info">
            <div class="si-name" style="opacity:.7">${esc(s.user_name)}</div>
            <div class="si-preview">Visto</div>
          </div>
          <div class="si-time">${fmtTime(s.created_at)}</div>
        </div>`).join('');
    } else { viewedLabel.style.display='none'; viewedList.innerHTML=''; }
  }

  function viewStatus(userId,idx){
    const s=allStatuses[idx]||allStatuses[0];
    if(!s) return;
    viewingIdx=idx; viewingUser=userId;
    // Mark as seen
    s.seen=true;
    renderStatusList();
    showStory(s);
  }

  function showStory(s){
    document.getElementById('viewer-empty').style.display='none';
    const sv=document.getElementById('story-viewer');
    sv.classList.add('visible');

    // Avatar
    const av=document.getElementById('sv-avatar');
    av.style.cssText=`background:${s.user_color}20;color:${s.user_color}`;
    av.textContent=s.user_initials;

    document.getElementById('sv-name').textContent=s.user_name;
    document.getElementById('sv-time').textContent=fmtTime(s.created_at);

    // Progress bars
    const bars=document.getElementById('story-bars');
    bars.innerHTML=`<div class="story-bar"><div class="story-bar-fill active" style="--dur:5s"></div></div>`;

    // Content
    const bg=document.getElementById('story-bg');
    const textOverlay=document.getElementById('story-text');

    if(s.type==='image'&&s.media_url){
      bg.innerHTML=`<img src="${s.media_url}" alt="">`;
      textOverlay.textContent='';
    } else if(s.type==='video'&&s.media_url){
      bg.innerHTML=`<video autoplay loop muted><source src="${s.media_url}"></video>`;
      textOverlay.textContent='';
    } else {
      bg.innerHTML='';
      bg.style.background=s.bg||COLORS[0];
      textOverlay.innerHTML=`<div>${s.emoji?`<div style="font-size:60px;margin-bottom:16px">${s.emoji}</div>`:''}<div>${esc(s.content)}</div></div>`;
    }

    // Auto advance
    clearTimeout(storyTimer);
    storyTimer=setTimeout(()=>nextStory(),5000);
  }

  function nextStory(){
    clearTimeout(storyTimer);
    if(viewingIdx<allStatuses.length-1){
      viewingIdx++;
      showStory(allStatuses[viewingIdx]);
      allStatuses[viewingIdx].seen=true;
      renderStatusList();
    } else {
      closeViewer();
    }
  }

  function prevStory(){
    clearTimeout(storyTimer);
    if(viewingIdx>0){
      viewingIdx--;
      showStory(allStatuses[viewingIdx]);
    }
  }

  function closeViewer(){
    clearTimeout(storyTimer);
    document.getElementById('story-viewer').classList.remove('visible');
    document.getElementById('viewer-empty').style.display='flex';
    viewingUser=null;
  }

  function reactStory(emoji){
    toast(emoji,`Rea√ß√£o enviada!`,`Voc√™ enviou ${emoji} para ${allStatuses[viewingIdx]?.user_name||'?'}`);
  }

  // ‚îÄ‚îÄ CREATE STATUS ‚îÄ‚îÄ
  function openCreate(){ document.getElementById('create-overlay').classList.add('visible'); }
  function closeCreate(){ document.getElementById('create-overlay').classList.remove('visible'); selectedMedia=null; document.getElementById('media-preview').style.display='none'; }

  function switchCreateTab(tab){
    createTab=tab;
    ['text','image','video'].forEach(t=>{
      document.getElementById(`tab-${t}`).style.display=t===tab?'block':'none';
    });
    document.querySelectorAll('.cc-tab').forEach((b,i)=>{
      b.classList.toggle('active',['text','image','video'][i]===tab);
    });
  }

  function renderColorRow(){
    document.getElementById('color-row').innerHTML=COLORS.map((c,i)=>
      `<div class="color-swatch ${i===0?'active':''}" style="background:${c}" onclick="selectColor('${c}',this)"></div>`
    ).join('');

    document.getElementById('status-text').addEventListener('input',()=>{
      document.getElementById('char-count').textContent=document.getElementById('status-text').value.length;
    });
  }

  function selectColor(color,el){
    selectedBg=color;
    document.querySelectorAll('.color-swatch').forEach(c=>c.classList.remove('active'));
    el.classList.add('active');
  }

  function handleMediaSelect(e){
    const file=e.target.files[0];
    if(!file) return;
    selectedMedia=file;
    const url=URL.createObjectURL(file);
    const preview=document.getElementById('media-preview');
    preview.style.display='block';
    preview.innerHTML=`<img src="${url}" style="max-height:160px;border-radius:10px;object-fit:cover;width:100%">`;
  }

  function handleVideoSelect(e){
    const file=e.target.files[0];
    if(!file) return;
    selectedMedia=file;
    toast('‚úÖ','V√≠deo selecionado',file.name.substring(0,30));
    switchCreateTab('video');
  }

  function setupDrag(){
    const dz=document.getElementById('drop-zone');
    if(!dz) return;
    dz.addEventListener('dragover',e=>{e.preventDefault();dz.style.borderColor='var(--green)'});
    dz.addEventListener('dragleave',()=>{dz.style.borderColor='var(--border)'});
    dz.addEventListener('drop',e=>{
      e.preventDefault(); dz.style.borderColor='var(--border)';
      const file=e.dataTransfer.files[0];
      if(file&&file.type.startsWith('image/')){ selectedMedia=file; const url=URL.createObjectURL(file); const p=document.getElementById('media-preview'); p.style.display='block'; p.innerHTML=`<img src="${url}" style="max-height:160px;border-radius:10px;object-fit:cover;width:100%">`; }
    });
  }

  async function publishStatus(){
    const text=document.getElementById('status-text').value.trim();
    const emoji=document.getElementById('status-emoji').value.trim();

    if(createTab==='text'&&!text){ toast('‚ö†Ô∏è','Erro','Escreva algo no status.'); return; }
    if((createTab==='image'||createTab==='video')&&!selectedMedia){ toast('‚ö†Ô∏è','Erro','Selecione um arquivo.'); return; }

    let mediaUrl=null;
    let type='text';
    if(selectedMedia){
      mediaUrl=URL.createObjectURL(selectedMedia);
      type=selectedMedia.type.startsWith('video/')? 'video':'image';
    }

    const newStatus={
      id:'s_'+Date.now(),
      user_id:session.id,
      user_name:session.name,
      user_initials:session.initials||getInitials(session.name),
      user_color:'#00C16A',
      type,
      content:text||selectedMedia?.name||'Novo status',
      media_url:mediaUrl,
      bg:selectedBg,
      emoji,
      created_at:new Date().toISOString(),
      seen:false
    };

    // Save
    const stored=JSON.parse(localStorage.getItem('pr_statuses')||'[]');
    stored.push(newStatus);
    localStorage.setItem('pr_statuses',JSON.stringify(stored));
    allStatuses.unshift(newStatus);
    renderStatusList();
    closeCreate();
    toast('‚úÖ','Status publicado!','Expira em 24 horas.');
    viewStatus(session.id,0);
  }

  // Utils
  function getInitials(n){if(!n)return'?';return n.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase()}
  function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
  function fmtTime(iso){if(!iso)return'';const d=new Date(iso);const diff=Date.now()-d;if(diff<60000)return'Agora';if(diff<3600000)return`${Math.floor(diff/60000)}m`;if(diff<86400000)return`${Math.floor(diff/3600000)}h`;return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})}

  function toast(icon,title,body){
    const wrap=document.getElementById('toast-wrap');
    const t=document.createElement('div');
    t.className='toast';
    t.innerHTML=`<div class="toast-icon">${icon}</div><div><div class="toast-title">${title}</div>${body?`<div class="toast-body">${body}</div>`:''}</div>`;
    t.onclick=()=>t.remove();
    wrap.appendChild(t);
    setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(30px)';t.style.transition='all .3s';setTimeout(()=>t.remove(),300);},4000);
  }

  document.getElementById('create-overlay').addEventListener('click',e=>{
    if(e.target===document.getElementById('create-overlay')) closeCreate();
  });
  document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeCreate();closeViewer();}});
</script>
</body>
</html>
