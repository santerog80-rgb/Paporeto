<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <script src="config.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PapoReto ‚Äî Chamada</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green:#00C16A; --green-dark:#009E56; --green-glow:rgba(0,193,106,0.25);
      --bg:#0A0F14; --surface:#111820; --surface2:#19232F; --surface3:#1F2D3E;
      --border:#1E2A38; --text:#E8F0F8; --muted:#6B7F94; --subtle:#2E3D50;
      --red:#FF4757; --red-glow:rgba(255,71,87,0.25);
      --blue:#58A6FF; --orange:#FF8C42; --purple:#BC8CFF;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: 'Sora', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    /* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
    .topbar {
      height: 58px; background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 16px; gap: 12px; flex-shrink: 0; z-index: 20;
    }
    .topbar-logo { display: flex; align-items: center; gap: 8px; text-decoration: none; margin-right: 8px; }
    .tl-icon { width: 34px; height: 34px; background: linear-gradient(135deg, var(--green), var(--green-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
    .tl-name { font-size: 17px; font-weight: 800; letter-spacing: -0.4px; color: var(--text); }
    .tl-name span { color: var(--green); }
    .page-label { font-size: 15px; font-weight: 700; color: var(--muted); }
    .topbar-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
    .icon-btn { width: 36px; height: 36px; border: none; border-radius: 9px; background: transparent; color: var(--muted); font-size: 17px; cursor: pointer; transition: all .15s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: var(--surface2); color: var(--text); }
    .back-btn { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 9px; border: none; background: transparent; cursor: pointer; font-family: 'Sora', sans-serif; transition: all .2s; }
    .back-btn:hover { color: var(--text); background: var(--surface2); }

    /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
    .app-body { display: flex; flex: 1; overflow: hidden; }

    /* ‚îÄ‚îÄ CONTACTS SIDEBAR ‚îÄ‚îÄ */
    .sidebar {
      width: 280px; background: var(--surface); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; flex-shrink: 0;
    }
    .sb-header { padding: 14px; border-bottom: 1px solid var(--border); }
    .sb-title { font-size: 15px; font-weight: 700; margin-bottom: 10px; }
    .sb-search { position: relative; }
    .sb-search input {
      width: 100%; padding: 9px 14px 9px 36px;
      background: var(--bg); border: 1.5px solid var(--border);
      border-radius: 10px; color: var(--text);
      font-family: 'Sora', sans-serif; font-size: 13px;
      outline: none; transition: border-color .2s;
    }
    .sb-search input:focus { border-color: var(--green); }
    .sb-search::before { content: 'üîç'; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 12px; pointer-events: none; }

    .contacts-list { flex: 1; overflow-y: auto; }
    .contacts-list::-webkit-scrollbar { width: 3px; }
    .contacts-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .contact-item {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px; cursor: pointer; transition: all .15s;
      border-left: 3px solid transparent; position: relative;
    }
    .contact-item:hover { background: var(--surface2); }
    .contact-item.active { background: var(--surface3); border-left-color: var(--green); }
    .ci-avatar {
      width: 44px; height: 44px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; font-weight: 700; flex-shrink: 0; position: relative;
    }
    .online-dot {
      position: absolute; bottom: 1px; right: 1px;
      width: 11px; height: 11px; background: var(--green);
      border-radius: 50%; border: 2px solid var(--surface);
    }
    .ci-info { flex: 1; overflow: hidden; }
    .ci-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ci-status { font-size: 12px; color: var(--muted); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ci-status.online { color: var(--green); }
    .ci-actions { display: flex; gap: 4px; opacity: 0; transition: opacity .15s; }
    .contact-item:hover .ci-actions { opacity: 1; }
    .call-mini-btn {
      width: 30px; height: 30px; border: none; border-radius: 8px;
      font-size: 14px; cursor: pointer; transition: all .15s;
      display: flex; align-items: center; justify-content: center;
    }
    .call-mini-btn.voice { background: rgba(0,193,106,0.12); color: var(--green); }
    .call-mini-btn.voice:hover { background: var(--green); color: #000; }
    .call-mini-btn.video { background: rgba(88,166,255,0.12); color: var(--blue); }
    .call-mini-btn.video:hover { background: var(--blue); color: #000; }

    .history-section { border-top: 1px solid var(--border); }
    .section-label {
      padding: 12px 14px 6px;
      font-size: 11px; color: var(--muted);
      text-transform: uppercase; letter-spacing: 1px;
      font-weight: 700; font-family: 'Space Mono', monospace;
    }
    .history-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px; cursor: pointer; transition: all .15s;
    }
    .history-item:hover { background: var(--surface2); }
    .hi-avatar {
      width: 38px; height: 38px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 700; flex-shrink: 0;
    }
    .hi-info { flex: 1; overflow: hidden; }
    .hi-name { font-size: 13px; font-weight: 600; }
    .hi-detail { font-size: 11px; color: var(--muted); margin-top: 2px; display: flex; align-items: center; gap: 5px; }
    .hi-type { font-size: 10px; }
    .hi-meta { text-align: right; flex-shrink: 0; }
    .hi-time { font-size: 11px; color: var(--subtle); font-family: 'Space Mono', monospace; }
    .hi-dur { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .missed-tag { color: var(--red); }

    /* ‚îÄ‚îÄ CALL AREA ‚îÄ‚îÄ */
    .call-area {
      flex: 1; display: flex; flex-direction: column;
      position: relative; overflow: hidden; background: var(--bg);
    }

    /* IDLE / WELCOME STATE */
    .call-idle {
      flex: 1; display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 20px; color: var(--muted);
    }
    .idle-icon {
      width: 120px; height: 120px; background: var(--surface2);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 52px; opacity: .5;
    }
    .idle-title { font-size: 22px; font-weight: 700; color: var(--text); }
    .idle-sub { font-size: 14px; color: var(--muted); text-align: center; max-width: 300px; line-height: 1.6; }
    .idle-cta { display: flex; gap: 12px; margin-top: 8px; }
    .cta-btn {
      padding: 12px 24px; border: none; border-radius: 12px;
      font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: all .2s; display: flex; align-items: center; gap: 8px;
    }
    .cta-btn.voice { background: var(--green); color: #000; box-shadow: 0 0 30px var(--green-glow); }
    .cta-btn.voice:hover { background: var(--green-dark); transform: translateY(-1px); }
    .cta-btn.video { background: var(--blue); color: #000; box-shadow: 0 0 30px rgba(88,166,255,0.2); }
    .cta-btn.video:hover { background: #3d8fe0; transform: translateY(-1px); }

    /* CALLING SCREEN */
    .call-screen {
      position: absolute; inset: 0;
      display: none; flex-direction: column;
      align-items: center; justify-content: center;
      background: linear-gradient(160deg, #0A1A10 0%, var(--bg) 60%, #0A1020 100%);
      z-index: 10;
    }
    .call-screen.active { display: flex; }
    .call-screen.video-mode { background: #000; }

    /* Animated background rings */
    .call-rings {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      pointer-events: none;
    }
    .ring {
      position: absolute;
      border-radius: 50%;
      border: 1px solid rgba(0,193,106,0.15);
      animation: expandRing 3s ease-out infinite;
    }
    .ring:nth-child(1) { width: 200px; height: 200px; animation-delay: 0s; }
    .ring:nth-child(2) { width: 320px; height: 320px; animation-delay: 0.8s; }
    .ring:nth-child(3) { width: 440px; height: 440px; animation-delay: 1.6s; }
    @keyframes expandRing {
      0% { opacity: 0.6; transform: scale(0.8); }
      100% { opacity: 0; transform: scale(1.4); }
    }

    .call-avatar-wrap { position: relative; margin-bottom: 24px; z-index: 1; }
    .call-avatar {
      width: 120px; height: 120px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 44px; font-weight: 800; border: 3px solid var(--green);
      box-shadow: 0 0 60px var(--green-glow), 0 0 0 8px rgba(0,193,106,0.06);
      overflow: hidden; flex-shrink: 0;
    }
    .call-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .speaking-pulse {
      position: absolute; inset: -8px;
      border-radius: 50%; border: 2px solid var(--green);
      opacity: 0;
      animation: speakPulse 1.2s ease-in-out infinite;
    }
    @keyframes speakPulse { 0%,100% { opacity:0; transform:scale(1); } 50% { opacity:0.5; transform:scale(1.08); } }

    .call-name { font-size: 28px; font-weight: 800; letter-spacing: -0.6px; z-index: 1; }
    .call-status { font-size: 14px; color: var(--muted); margin-top: 6px; z-index: 1; }
    .call-status.ringing { color: var(--orange); }
    .call-status.connected { color: var(--green); }
    .call-timer {
      font-family: 'Space Mono', monospace; font-size: 22px; font-weight: 700;
      color: var(--green); margin-top: 8px; z-index: 1;
      display: none;
    }

    /* Controls */
    .call-controls { display: flex; align-items: center; gap: 16px; margin-top: 40px; z-index: 1; }
    .ctrl-btn {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      cursor: pointer;
    }
    .ctrl-circle {
      width: 60px; height: 60px; border-radius: 50%;
      border: none; display: flex; align-items: center; justify-content: center;
      font-size: 22px; cursor: pointer; transition: all .2s;
    }
    .ctrl-circle.muted { background: rgba(255,255,255,0.08); color: var(--text); }
    .ctrl-circle.muted:hover { background: rgba(255,255,255,0.14); }
    .ctrl-circle.muted.on { background: rgba(255,71,87,0.2); color: var(--red); }
    .ctrl-circle.hangup { background: var(--red); color: #fff; width: 72px; height: 72px; font-size: 26px; box-shadow: 0 0 40px var(--red-glow); }
    .ctrl-circle.hangup:hover { background: #e0314a; transform: scale(1.05); }
    .ctrl-circle.answer { background: var(--green); color: #000; width: 72px; height: 72px; font-size: 26px; box-shadow: 0 0 40px var(--green-glow); }
    .ctrl-circle.answer:hover { background: var(--green-dark); transform: scale(1.05); }
    .ctrl-label { font-size: 12px; color: var(--muted); font-weight: 500; }

    /* Video overlay: local stream preview */
    .video-local {
      position: absolute; bottom: 100px; right: 24px;
      width: 160px; height: 100px; border-radius: 12px;
      background: var(--surface3); border: 2px solid var(--border);
      display: none; align-items: center; justify-content: center;
      font-size: 28px; overflow: hidden; z-index: 2;
    }
    .call-screen.video-mode .video-local { display: flex; }
    .video-remote {
      position: absolute; inset: 0;
      background: #000; display: flex; align-items: center; justify-content: center;
    }
    .video-remote-placeholder { font-size: 64px; opacity: .15; }

    /* Incoming call overlay */
    .incoming-overlay {
      position: absolute; inset: 0; z-index: 30;
      background: rgba(10,15,20,0.9);
      backdrop-filter: blur(10px);
      display: none; flex-direction: column;
      align-items: center; justify-content: center; gap: 16px;
    }
    .incoming-overlay.visible { display: flex; }
    .incoming-glow {
      width: 140px; height: 140px; border-radius: 50%;
      background: linear-gradient(135deg, var(--green), var(--green-dark));
      display: flex; align-items: center; justify-content: center;
      font-size: 52px; font-weight: 800;
      box-shadow: 0 0 80px var(--green-glow);
      animation: pulse-incoming 1.5s ease-in-out infinite;
      overflow: hidden;
    }
    @keyframes pulse-incoming { 0%,100% { box-shadow: 0 0 60px var(--green-glow); } 50% { box-shadow: 0 0 100px rgba(0,193,106,0.4); } }
    .incoming-name { font-size: 26px; font-weight: 800; }
    .incoming-type { font-size: 14px; color: var(--muted); }
    .incoming-actions { display: flex; gap: 40px; margin-top: 16px; }
    .inc-btn { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; }
    .inc-circle {
      width: 72px; height: 72px; border-radius: 50%;
      border: none; font-size: 26px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all .2s;
    }
    .inc-circle.decline { background: var(--red); color: #fff; box-shadow: 0 0 40px var(--red-glow); }
    .inc-circle.decline:hover { transform: scale(1.05); }
    .inc-circle.accept { background: var(--green); color: #000; box-shadow: 0 0 40px var(--green-glow); }
    .inc-circle.accept:hover { transform: scale(1.05); }
    .inc-label { font-size: 13px; color: var(--muted); font-weight: 500; }

    /* TOAST */
    .toast-wrap { position: fixed; bottom: 24px; right: 24px; display: flex; flex-direction: column; gap: 8px; z-index: 9999; }
    .toast { display: flex; align-items: center; gap: 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; font-size: 13px; min-width: 240px; animation: slideToast .3s ease; cursor: pointer; box-shadow: 0 4px 24px rgba(0,0,0,0.4); }
    @keyframes slideToast { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:translateX(0); } }
    .toast-icon { font-size: 20px; flex-shrink: 0; }
    .toast-title { font-weight: 600; }
    .toast-body { color: var(--muted); margin-top: 2px; font-size: 12px; }

    @media (max-width: 768px) {
      .sidebar { display: none; }
    }
  </style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <a href="chat.html" class="topbar-logo">
    <div class="tl-icon">üí¨</div>
    <span class="tl-name">Papo<span>Reto</span></span>
  </a>
  <span class="page-label">üìû Chamadas</span>
  <div class="topbar-right">
    <a href="chat.html" class="back-btn">‚Üê Voltar ao Chat</a>
  </div>
</div>

<div class="app-body">

  <!-- CONTACTS SIDEBAR -->
  <div class="sidebar">
    <div class="sb-header">
      <div class="sb-title">Contatos</div>
      <div class="sb-search">
        <input type="text" placeholder="Buscar contato..." id="search-contacts" oninput="filterContacts(this.value)">
      </div>
    </div>

    <div class="contacts-list" id="contacts-list">
      <!-- populated by JS -->
    </div>

    <div class="history-section">
      <div class="section-label">Hist√≥rico</div>
      <div id="call-history">
        <!-- populated by JS -->
      </div>
    </div>
  </div>

  <!-- CALL AREA -->
  <div class="call-area" id="call-area">

    <!-- IDLE STATE -->
    <div class="call-idle" id="call-idle">
      <div class="idle-icon">üìû</div>
      <div class="idle-title">Pronto para ligar?</div>
      <div class="idle-sub">Selecione um contato na lista ou inicie uma chamada de voz e v√≠deo a qualquer momento.</div>
      <div class="idle-cta">
        <button class="cta-btn voice" onclick="startCallWith(null,'voice')">üìû Chamada de Voz</button>
        <button class="cta-btn video" onclick="startCallWith(null,'video')">üìπ Videochamada</button>
      </div>
    </div>

    <!-- CALL SCREEN -->
    <div class="call-screen" id="call-screen">
      <!-- Background rings -->
      <div class="call-rings">
        <div class="ring"></div>
        <div class="ring"></div>
        <div class="ring"></div>
      </div>

      <!-- Remote video -->
      <div class="video-remote" id="video-remote">
        <div class="video-remote-placeholder">üë§</div>
        <video id="remote-video" autoplay playsinline style="width:100%;height:100%;object-fit:cover;display:none;"></video>
      </div>

      <!-- Avatar -->
      <div class="call-avatar-wrap">
        <div class="call-avatar" id="call-avatar-display">
          <span id="call-avatar-initials">?</span>
        </div>
        <div class="speaking-pulse" id="speaking-pulse"></div>
      </div>

      <div class="call-name" id="call-contact-name">‚Äî</div>
      <div class="call-status ringing" id="call-status-text">A ligar...</div>
      <div class="call-timer" id="call-timer">00:00</div>

      <!-- Controls -->
      <div class="call-controls" id="call-controls">
        <div class="ctrl-btn">
          <button class="ctrl-circle muted" id="btn-mute" onclick="toggleMute()">üéôÔ∏è</button>
          <span class="ctrl-label" id="mute-label">Mudo</span>
        </div>
        <div class="ctrl-btn">
          <button class="ctrl-circle muted" id="btn-speaker" onclick="toggleSpeaker()">üîä</button>
          <span class="ctrl-label">Altifalante</span>
        </div>
        <div class="ctrl-btn">
          <button class="ctrl-circle hangup" onclick="hangup()">üìµ</button>
          <span class="ctrl-label" style="color:var(--red)">Desligar</span>
        </div>
        <div class="ctrl-btn" id="btn-cam-wrap">
          <button class="ctrl-circle muted" id="btn-camera" onclick="toggleCamera()">üì∑</button>
          <span class="ctrl-label">C√¢mera</span>
        </div>
        <div class="ctrl-btn">
          <button class="ctrl-circle muted" onclick="toggleKeypad()">üî¢</button>
          <span class="ctrl-label">Teclado</span>
        </div>
      </div>

      <!-- Local video -->
      <div class="video-local" id="video-local">
        <span id="local-placeholder">üì∑</span>
        <video id="local-video" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover;display:none;"></video>
      </div>
    </div>

    <!-- INCOMING OVERLAY -->
    <div class="incoming-overlay" id="incoming-overlay">
      <div class="call-rings"><div class="ring"></div><div class="ring"></div><div class="ring"></div></div>
      <div class="incoming-glow" id="incoming-avatar-display">üë§</div>
      <div class="incoming-name" id="incoming-name">‚Äî</div>
      <div class="incoming-type" id="incoming-type">Chamada de Voz</div>
      <div class="incoming-actions">
        <div class="inc-btn">
          <button class="inc-circle decline" onclick="declineCall()">üìµ</button>
          <span class="inc-label">Recusar</span>
        </div>
        <div class="inc-btn">
          <button class="inc-circle accept" onclick="acceptCall()">üìû</button>
          <span class="inc-label">Aceitar</span>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="toast-wrap" id="toast-wrap"></div>

<script>
  const COLORS = ['#00C16A','#58A6FF','#BC8CFF','#FF8C42','#FF4757','#00D4AA'];
  let session = null;
  let currentCall = null; // { contact, type, state:'ringing'|'connected'|'ended' }
  let callTimerInterval = null;
  let callSecs = 0;
  let isMuted = false;
  let isSpeaker = true;
  let isCameraOff = false;
  let localStream = null;

  const DEMO_CONTACTS = [
    { id:'c1', name:'Ana Paula', phone:'+258841000001', online:true, color:'#00C16A' },
    { id:'c2', name:'Bruno Macu√°cua', phone:'+258842000002', online:true, color:'#58A6FF' },
    { id:'c3', name:'Carlos Nhantumbo', phone:'+258843000003', online:false, color:'#BC8CFF' },
    { id:'c4', name:'Dina Cossa', phone:'+258844000004', online:true, color:'#FF8C42' },
    { id:'c5', name:'Eduardo Muianga', phone:'+258845000005', online:false, color:'#FF4757' },
  ];

  const DEMO_HISTORY = [
    { contact:'Ana Paula', type:'voice', duration:'3:42', time:'Hoje 14:23', missed:false, color:'#00C16A' },
    { contact:'Bruno Macu√°cua', type:'video', duration:'12:07', time:'Hoje 11:05', missed:false, color:'#58A6FF' },
    { contact:'Carlos Nhantumbo', type:'voice', duration:'', time:'Ontem 19:50', missed:true, color:'#BC8CFF' },
    { contact:'Dina Cossa', type:'voice', duration:'0:55', time:'Ontem 09:12', missed:false, color:'#FF8C42' },
    { contact:'Eduardo Muianga', type:'video', duration:'', time:'Seg 16:30', missed:true, color:'#FF4757' },
  ];

  window.addEventListener('load', () => {
    session = PR.Session.require('login.html'); if (!session) return;
    renderContacts(DEMO_CONTACTS);
    renderHistory(DEMO_HISTORY);

    // Simulate incoming call after 5s for demo
    setTimeout(() => simulateIncoming(), 5000);
  });

  function getInitials(n) {
    if (!n) return '?';
    return n.split(' ').slice(0,2).map(w => w[0]).join('').toUpperCase();
  }

  function renderContacts(list) {
    const el = document.getElementById('contacts-list');
    if (!list.length) {
      el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px">Nenhum contato encontrado</div>';
      return;
    }
    el.innerHTML = list.map(c => `
      <div class="contact-item" onclick="startCallWith('${c.id}','voice')" id="ci-${c.id}">
        <div class="ci-avatar" style="background:${c.color}22;color:${c.color}">
          ${getInitials(c.name)}
          ${c.online ? '<div class="online-dot"></div>' : ''}
        </div>
        <div class="ci-info">
          <div class="ci-name">${esc(c.name)}</div>
          <div class="ci-status ${c.online ? 'online' : ''}">${c.online ? '‚óè Online' : 'Offline'}</div>
        </div>
        <div class="ci-actions">
          <button class="call-mini-btn voice" onclick="event.stopPropagation();startCallWith('${c.id}','voice')" title="Chamada de Voz">üìû</button>
          <button class="call-mini-btn video" onclick="event.stopPropagation();startCallWith('${c.id}','video')" title="Videochamada">üìπ</button>
        </div>
      </div>
    `).join('');
  }

  function renderHistory(list) {
    const el = document.getElementById('call-history');
    el.innerHTML = list.map(h => `
      <div class="history-item">
        <div class="hi-avatar" style="background:${h.color}22;color:${h.color}">${getInitials(h.contact)}</div>
        <div class="hi-info">
          <div class="hi-name ${h.missed ? 'missed-tag' : ''}">${esc(h.contact)}</div>
          <div class="hi-detail">
            <span class="hi-type">${h.type === 'video' ? 'üìπ' : 'üìû'}</span>
            <span>${h.missed ? '‚ùå Perdida' : '‚úÖ ' + h.type}</span>
          </div>
        </div>
        <div class="hi-meta">
          <div class="hi-time">${h.time}</div>
          <div class="hi-dur">${h.duration || '‚Äî'}</div>
        </div>
      </div>
    `).join('');
  }

  function filterContacts(q) {
    const filtered = DEMO_CONTACTS.filter(c => c.name.toLowerCase().includes(q.toLowerCase()));
    renderContacts(filtered);
  }

  function startCallWith(contactId, type) {
    const contact = contactId
      ? DEMO_CONTACTS.find(c => c.id === contactId)
      : { id:'new', name:'Novo Contato', color: '#00C16A' };

    if (!contact) return;

    currentCall = { contact, type, state: 'ringing' };
    callSecs = 0;

    // Show call screen
    document.getElementById('call-idle').style.display = 'none';
    const screen = document.getElementById('call-screen');
    screen.classList.add('active');
    if (type === 'video') screen.classList.add('video-mode');
    else screen.classList.remove('video-mode');

    // Update UI
    const avatarEl = document.getElementById('call-avatar-display');
    avatarEl.style.background = `${contact.color}22`;
    avatarEl.style.color = contact.color;
    avatarEl.style.borderColor = contact.color;
    document.getElementById('call-avatar-initials').textContent = getInitials(contact.name);
    document.getElementById('call-contact-name').textContent = contact.name;
    document.getElementById('call-status-text').textContent = type === 'video' ? 'üìπ A ligar por v√≠deo...' : 'üìû A ligar...';
    document.getElementById('call-status-text').className = 'call-status ringing';
    document.getElementById('call-timer').style.display = 'none';

    // Request camera if video
    if (type === 'video') {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          localStream = stream;
          const localVid = document.getElementById('local-video');
          localVid.srcObject = stream;
          localVid.style.display = 'block';
          document.getElementById('local-placeholder').style.display = 'none';
        })
        .catch(() => toast('‚ö†Ô∏è', 'C√¢mera indispon√≠vel', 'Continuando sem v√≠deo.'));
    } else {
      navigator.mediaDevices.getUserMedia({ audio: true }).catch(() => {});
    }

    // Simulate answer after 3s
    setTimeout(() => answerSimulated(), 3000);
  }

  function answerSimulated() {
    if (!currentCall) return;
    currentCall.state = 'connected';
    document.getElementById('call-status-text').textContent = 'Conectado';
    document.getElementById('call-status-text').className = 'call-status connected';
    document.getElementById('call-timer').style.display = 'block';
    startTimer();
    toast('‚úÖ', 'Chamada conectada', currentCall.contact.name);
  }

  function startTimer() {
    clearInterval(callTimerInterval);
    callTimerInterval = setInterval(() => {
      callSecs++;
      const m = String(Math.floor(callSecs / 60)).padStart(2, '0');
      const s = String(callSecs % 60).padStart(2, '0');
      document.getElementById('call-timer').textContent = `${m}:${s}`;
    }, 1000);
  }

  function hangup() {
    if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
    clearInterval(callTimerInterval);
    const dur = callSecs > 0
      ? `${String(Math.floor(callSecs/60)).padStart(2,'0')}:${String(callSecs%60).padStart(2,'0')}`
      : null;

    document.getElementById('call-screen').classList.remove('active', 'video-mode');
    document.getElementById('call-idle').style.display = 'flex';
    document.getElementById('incoming-overlay').classList.remove('visible');

    if (dur) toast('üìµ', 'Chamada encerrada', `Dura√ß√£o: ${dur}`);
    else toast('üìµ', 'Chamada encerrada', 'Chamada n√£o foi atendida.');
    currentCall = null;
  }

  function toggleMute() {
    isMuted = !isMuted;
    const btn = document.getElementById('btn-mute');
    const lbl = document.getElementById('mute-label');
    btn.textContent = isMuted ? 'üîá' : 'üéôÔ∏è';
    btn.classList.toggle('on', isMuted);
    lbl.textContent = isMuted ? 'Sem Som' : 'Mudo';
    if (localStream) localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
    toast(isMuted ? 'üîá' : 'üéôÔ∏è', isMuted ? 'Microfone desligado' : 'Microfone ligado', '');
  }

  function toggleSpeaker() {
    isSpeaker = !isSpeaker;
    const btn = document.getElementById('btn-speaker');
    btn.textContent = isSpeaker ? 'üîä' : 'üîà';
    btn.classList.toggle('on', !isSpeaker);
    toast(isSpeaker ? 'üîä' : 'üîá', isSpeaker ? 'Altifalante ligado' : 'Altifalante desligado', '');
  }

  function toggleCamera() {
    if (!currentCall || currentCall.type !== 'video') {
      toast('‚ö†Ô∏è', 'N√£o dispon√≠vel', 'C√¢mera apenas em videochamadas.'); return;
    }
    isCameraOff = !isCameraOff;
    const btn = document.getElementById('btn-camera');
    btn.textContent = isCameraOff ? 'üö´' : 'üì∑';
    btn.classList.toggle('on', isCameraOff);
    if (localStream) localStream.getVideoTracks().forEach(t => t.enabled = !isCameraOff);
    toast(isCameraOff ? 'üì∑' : '‚úÖ', isCameraOff ? 'C√¢mera desligada' : 'C√¢mera ligada', '');
  }

  function toggleKeypad() {
    toast('üî¢', 'Teclado', 'Funcionalidade em breve.');
  }

  // Incoming call simulation
  let incomingContact = null;
  let incomingType = 'voice';

  function simulateIncoming() {
    if (currentCall) return; // already in a call
    incomingContact = DEMO_CONTACTS[1]; // Bruno
    incomingType = 'voice';

    document.getElementById('incoming-avatar-display').textContent = getInitials(incomingContact.name);
    document.getElementById('incoming-name').textContent = incomingContact.name;
    document.getElementById('incoming-type').textContent = 'üìû Chamada de Voz';
    document.getElementById('incoming-overlay').classList.add('visible');
  }

  function acceptCall() {
    document.getElementById('incoming-overlay').classList.remove('visible');
    currentCall = { contact: incomingContact, type: incomingType, state: 'connected' };
    callSecs = 0;

    document.getElementById('call-idle').style.display = 'none';
    const screen = document.getElementById('call-screen');
    screen.classList.add('active');

    const avatarEl = document.getElementById('call-avatar-display');
    avatarEl.style.background = `${incomingContact.color}22`;
    avatarEl.style.color = incomingContact.color;
    avatarEl.style.borderColor = incomingContact.color;
    document.getElementById('call-avatar-initials').textContent = getInitials(incomingContact.name);
    document.getElementById('call-contact-name').textContent = incomingContact.name;
    document.getElementById('call-status-text').textContent = 'Conectado';
    document.getElementById('call-status-text').className = 'call-status connected';
    document.getElementById('call-timer').style.display = 'block';
    startTimer();
    toast('‚úÖ', 'Chamada aceite', incomingContact.name);
  }

  function declineCall() {
    document.getElementById('incoming-overlay').classList.remove('visible');
    toast('üìµ', 'Chamada recusada', incomingContact ? incomingContact.name : '');
    incomingContact = null;
  }

  function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function toast(icon, title, body) {
    const wrap = document.getElementById('toast-wrap');
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerHTML = `<div class="toast-icon">${icon}</div><div><div class="toast-title">${title}</div>${body ? `<div class="toast-body">${body}</div>` : ''}</div>`;
    t.onclick = () => t.remove();
    wrap.appendChild(t);
    setTimeout(() => { t.style.opacity='0'; t.style.transform='translateX(20px)'; t.style.transition='all .3s'; setTimeout(() => t.remove(), 300); }, 4000);
  }
</script>
</body>
</html>
